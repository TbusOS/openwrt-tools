# Kernel Snapshot å·¥å…· - è¯¦ç»†ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¦‚è¿°

Kernel Snapshot æ˜¯ä¸€ä¸ª Git é£æ ¼çš„æ–‡ä»¶å¿«ç…§å·¥å…·ï¼Œä¸“ä¸ºå†…æ ¸å¼€å‘å’Œå¤§å‹ä»£ç åº“è®¾è®¡ã€‚æ”¯æŒæ™ºèƒ½ç´¢å¼•ç¼“å­˜ã€æ–‡ä»¶å¿½ç•¥ã€å…¨å±€é…ç½®ç­‰é«˜çº§åŠŸèƒ½ã€‚

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨æ­¥éª¤

```bash
# æ­¥éª¤ 1: åˆ‡æ¢åˆ°æ‚¨çš„é¡¹ç›®ç›®å½•
cd /path/to/your/kernel/source

# æ­¥éª¤ 2: åˆ›å»ºåŸºçº¿å¿«ç…§
./kernel_snapshot create linux-6.6

# æ­¥éª¤ 3: ä¿®æ”¹ä»£ç æ–‡ä»¶
echo "// æ–°åŠŸèƒ½" >> drivers/new_feature.c

# æ­¥éª¤ 4: æŸ¥çœ‹å˜æ›´
./kernel_snapshot status
```

### 2. ä½¿ç”¨å…¨å±€é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

```bash
# æ­¥éª¤ 1: åˆ›å»ºå…¨å±€é…ç½®æ–‡ä»¶
cat > .kernel_snapshot.conf << 'EOF'
# é»˜è®¤å·¥ä½œç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰
default_workspace_dir=/home/user/linux-kernel-6.6

# é»˜è®¤é¡¹ç›®åç§°
default_project_name=linux-6.6-dev

# å¿½ç•¥æ–‡ä»¶æ¨¡å¼ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
ignore_patterns=.git,*.tmp,*.log,*.bak,*.o,*.ko,build/,scripts/kconfig/.tmp*
EOF

# æ­¥éª¤ 2: æ— éœ€æŒ‡å®šå‚æ•°ï¼Œç›´æ¥åˆ›å»º
./kernel_snapshot create

# æ­¥éª¤ 3: å¿«é€ŸçŠ¶æ€æ£€æŸ¥
./kernel_snapshot status
```

## âš™ï¸ é…ç½®æ–‡ä»¶è¯¦è§£

### é…ç½®æ–‡ä»¶ä½ç½®

å·¥å…·æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼š

1. **å·¥å…·æ‰€åœ¨ç›®å½•**ï¼ˆæ¨èï¼‰ï¼š`/path/to/kernel_snapshot/.kernel_snapshot.conf`
2. **å½“å‰æ‰§è¡Œç›®å½•**ï¼š`./.kernel_snapshot.conf`
3. **ç”¨æˆ·ä¸»ç›®å½•**ï¼š`~/.kernel_snapshot.conf`

### å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹

```ini
# kernel_snapshot å…¨å±€é…ç½®æ–‡ä»¶
# æ­¤æ–‡ä»¶ç”¨äºè®¾ç½®é»˜è®¤çš„å·¥ä½œç›®å½•å’Œå¿½ç•¥æ¨¡å¼

# ==========================================
# åŸºæœ¬é…ç½®
# ==========================================

# é»˜è®¤å·¥ä½œç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰
# å¦‚æœè®¾ç½®ï¼Œcreate å‘½ä»¤å°†é»˜è®¤åœ¨æ­¤ç›®å½•åˆ›å»ºå¿«ç…§
default_workspace_dir=/home/developer/projects/linux-kernel

# é»˜è®¤é¡¹ç›®åç§°
# ç”¨äºè‡ªåŠ¨å‘½åé¡¹ç›®ï¼Œå¦‚æœå‘½ä»¤è¡ŒæœªæŒ‡å®š
default_project_name=linux-mainline

# ==========================================
# æ–‡ä»¶å¿½ç•¥é…ç½®
# ==========================================

# å¿½ç•¥æ–‡ä»¶æ¨¡å¼ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰
# æ”¯æŒå¤šç§åŒ¹é…æ¨¡å¼ï¼š
ignore_patterns=.git,.snapshot,*.tmp,*.log,*.bak,*.o,*.ko,*.mod.c,build/,scripts/kconfig/.tmp*,Documentation/output/,arch/*/boot/compressed/vmlinux*

# ==========================================
# é«˜çº§é…ç½®ç¤ºä¾‹
# ==========================================

# é’ˆå¯¹ä¸åŒé¡¹ç›®ç±»å‹çš„å¿½ç•¥æ¨¡å¼ç¤ºä¾‹ï¼š

# å†…æ ¸å¼€å‘é¡¹ç›®ï¼š
# ignore_patterns=.git,*.o,*.ko,*.mod.c,*.tmp,*.log,build/,scripts/kconfig/.tmp*,vmlinux*,System.map,Module.symvers

# Web å¼€å‘é¡¹ç›®ï¼š
# ignore_patterns=.git,node_modules/,*.log,*.tmp,dist/,build/,.env,coverage/

# C/C++ é¡¹ç›®ï¼š
# ignore_patterns=.git,*.o,*.obj,*.exe,*.dll,*.so,*.a,*.lib,build/,Debug/,Release/,*.tmp
```

### å¿½ç•¥æ¨¡å¼è¯´æ˜

æ”¯æŒçš„åŒ¹é…æ¨¡å¼ï¼š

| æ¨¡å¼ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|---------|------|------|
| åç¼€åŒ¹é… | `*.tmp`, `*.log`, `*.o` | åŒ¹é…ç‰¹å®šæ‰©å±•åçš„æ–‡ä»¶ |
| å‰ç¼€åŒ¹é… | `temp_*`, `backup_*` | åŒ¹é…ç‰¹å®šå‰ç¼€çš„æ–‡ä»¶ |
| ç²¾ç¡®åŒ¹é… | `.git`, `node_modules` | ç²¾ç¡®åŒ¹é…æ–‡ä»¶æˆ–ç›®å½•å |
| è·¯å¾„åŒ¹é… | `build/`, `scripts/tmp/` | åŒ¹é…åŒ…å«ç‰¹å®šè·¯å¾„çš„æ–‡ä»¶ |

## ğŸš€ å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å†…æ ¸å¼€å‘å·¥ä½œæµ

```bash
# 1. è®¾ç½®å†…æ ¸å¼€å‘ç¯å¢ƒ
cd /usr/src/linux-6.6
./kernel_snapshot create kernel-6.6-base

# 2. å¼€å‘æ–°åŠŸèƒ½
git checkout -b new-feature
# ... ä¿®æ”¹ä»£ç  ...

# 3. æŸ¥çœ‹æ‰€æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬æœªè·Ÿè¸ªæ–‡ä»¶ï¼‰
./kernel_snapshot status
# è¾“å‡ºç¤ºä¾‹ï¼š
# ğŸ” å·®å¼‚åˆ†ææŠ¥å‘Š:
# ================
# ğŸ†• æ–°å¢çš„æ–‡ä»¶:
# A       drivers/gpu/new_driver.c
# A       include/linux/new_api.h
# 
# ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶:
# M       drivers/gpu/Makefile
# M       include/linux/module.h

# 4. ç¼–è¯‘æµ‹è¯•
make -j$(nproc)

# 5. å†æ¬¡æ£€æŸ¥ï¼ˆç¼–è¯‘äº§ç‰©ä¼šè¢«è‡ªåŠ¨å¿½ç•¥ï¼‰
./kernel_snapshot status
```

### åœºæ™¯ 2: å¤šé¡¹ç›®ç®¡ç†

```bash
# é…ç½®æ–‡ä»¶æ”¯æŒåŠ¨æ€åˆ‡æ¢é¡¹ç›®
cat > project-switcher.sh << 'EOF'
#!/bin/bash

case "$1" in
    "kernel")
        echo "default_workspace_dir=/usr/src/linux-6.6" > .kernel_snapshot.conf
        echo "default_project_name=linux-6.6" >> .kernel_snapshot.conf
        ;;
    "uboot")
        echo "default_workspace_dir=/usr/src/u-boot" > .kernel_snapshot.conf
        echo "default_project_name=u-boot-dev" >> .kernel_snapshot.conf
        ;;
    "openwrt")
        echo "default_workspace_dir=/home/user/openwrt" > .kernel_snapshot.conf
        echo "default_project_name=openwrt-main" >> .kernel_snapshot.conf
        ;;
esac
echo "ignore_patterns=.git,*.o,*.tmp,*.log,build/" >> .kernel_snapshot.conf
EOF

chmod +x project-switcher.sh

# ä½¿ç”¨æ–¹æ³•
./project-switcher.sh kernel
./kernel_snapshot create

./project-switcher.sh openwrt  
./kernel_snapshot create
```

### åœºæ™¯ 3: è¡¥ä¸å¼€å‘å·¥ä½œæµ

```bash
# 1. åˆ›å»ºå¹²å‡€çš„åŸºçº¿
./kernel_snapshot create clean-base

# 2. åº”ç”¨è¡¥ä¸å¹¶æµ‹è¯•
patch -p1 < security-fix.patch

# 3. æŸ¥çœ‹è¡¥ä¸å®é™…ä¿®æ”¹äº†ä»€ä¹ˆ
./kernel_snapshot status
# å¯ä»¥çœ‹åˆ°æ‰€æœ‰è¢«è¡¥ä¸ä¿®æ”¹çš„æ–‡ä»¶

# 4. æ‰‹åŠ¨å¾®è°ƒ
vim drivers/affected_driver.c

# 5. æœ€ç»ˆéªŒè¯
./kernel_snapshot status
# ç¡®è®¤ä¿®æ”¹èŒƒå›´ç¬¦åˆé¢„æœŸ
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. åˆç†é…ç½®å¿½ç•¥æ¨¡å¼

```bash
# âŒ ä¸å¥½çš„é…ç½® - å¤ªå®½æ³›
ignore_patterns=*

# âŒ ä¸å¥½çš„é…ç½® - é—æ¼é‡è¦ä¸´æ—¶æ–‡ä»¶
ignore_patterns=.git

# âœ… å¥½çš„é…ç½® - ç²¾ç¡®ä¸”å®Œæ•´
ignore_patterns=.git,.snapshot,*.tmp,*.log,*.bak,*.o,*.ko,build/,scripts/kconfig/.tmp*
```

### 2. ç´¢å¼•ç¼“å­˜ä¼˜åŒ–

```bash
# å¤§å‹é¡¹ç›®é¦–æ¬¡åˆ›å»ºä¼šç”Ÿæˆç´¢å¼•ç¼“å­˜
./kernel_snapshot create linux-huge-project

# åç»­ status æ£€æŸ¥ä¼šéå¸¸å¿«é€Ÿ
time ./kernel_snapshot status
# é€šå¸¸åœ¨å‡ ç™¾æ¯«ç§’å†…å®Œæˆï¼Œå³ä½¿å¯¹äºæœ‰æ•°ä¸‡æ–‡ä»¶çš„é¡¹ç›®
```

### 3. å¤šçº¿ç¨‹é…ç½®

```bash
# å¯¹äºå¤§å‹é¡¹ç›®ï¼Œå¯ä»¥è°ƒæ•´çº¿ç¨‹æ•°
./kernel_snapshot create -t 16 huge-project

# å¯¹äº SSD å­˜å‚¨ï¼Œé€šå¸¸é»˜è®¤çº¿ç¨‹æ•°å·²ç»è¶³å¤Ÿ
./kernel_snapshot create normal-project
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. é…ç½®æ–‡ä»¶æœªç”Ÿæ•ˆ

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶ä½ç½®
ls -la .kernel_snapshot.conf
ls -la ~/.kernel_snapshot.conf

# éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
cat .kernel_snapshot.conf
# ç¡®ä¿æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦
```

#### 2. æ–‡ä»¶å¿½ç•¥ä¸ç”Ÿæ•ˆ

```bash
# æµ‹è¯•å¿½ç•¥æ¨¡å¼
echo "æµ‹è¯•" > test.tmp
./kernel_snapshot status
# å¦‚æœ test.tmp å‡ºç°åœ¨æ–°å¢æ–‡ä»¶ä¸­ï¼Œè¯´æ˜å¿½ç•¥æ¨¡å¼æœ‰é—®é¢˜

# æ£€æŸ¥æ¨¡å¼è¯­æ³•
# âœ… æ­£ç¡®ï¼š*.tmp
# âŒ é”™è¯¯ï¼š*.tmp*ï¼ˆä¼šåŒ¹é… .tmpx ç­‰æ„å¤–æ–‡ä»¶ï¼‰
```

#### 3. æ€§èƒ½é—®é¢˜

```bash
# æ£€æŸ¥å¿½ç•¥çš„æ–‡ä»¶æ•°é‡
find . -name "*.o" | wc -l
find . -name "*.tmp" | wc -l

# å¦‚æœä¸´æ—¶æ–‡ä»¶å¾ˆå¤šï¼Œç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®å¿½ç•¥
grep -i "\.o\|\.tmp" .kernel_snapshot.conf
```

## ğŸ“ˆ é«˜çº§ç”¨æ³•

### 1. ç»“åˆ Git ä½¿ç”¨

```bash
# Git è·Ÿè¸ªæºç å˜æ›´ï¼ŒSnapshot è·Ÿè¸ªå®Œæ•´çŠ¶æ€
git status                    # æŸ¥çœ‹ Git ç®¡ç†çš„å˜æ›´
./kernel_snapshot status      # æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶å˜æ›´ï¼ˆåŒ…æ‹¬æœªè·Ÿè¸ªæ–‡ä»¶ï¼‰

# åœºæ™¯ï¼šæŸ¥çœ‹ç¼–è¯‘åçš„å®Œæ•´å½±å“
make clean
./kernel_snapshot create before-build
make -j$(nproc)
./kernel_snapshot status      # æŸ¥çœ‹ç¼–è¯‘äº§ç”Ÿçš„æ–‡ä»¶
```

### 2. è‡ªåŠ¨åŒ–è„šæœ¬é›†æˆ

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ç¤ºä¾‹

set -e

echo "ğŸ”„ å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹..."

# 1. åˆ›å»ºåŸºçº¿
./kernel_snapshot create test-baseline

# 2. è¿è¡Œæµ‹è¯•
echo "ğŸ“ åº”ç”¨æµ‹è¯•è¡¥ä¸..."
patch -p1 < test.patch

# 3. éªŒè¯å˜æ›´èŒƒå›´
echo "ğŸ” éªŒè¯å˜æ›´èŒƒå›´..."
CHANGES=$(./kernel_snapshot status | grep -E "^[AMD]" | wc -l)
if [ "$CHANGES" -gt 50 ]; then
    echo "âš ï¸  è­¦å‘Šï¼šå˜æ›´æ–‡ä»¶è¿‡å¤š ($CHANGES ä¸ªæ–‡ä»¶)"
    exit 1
fi

# 4. ç¼–è¯‘æµ‹è¯•
echo "ğŸ”¨ ç¼–è¯‘æµ‹è¯•..."
make -j$(nproc)

# 5. æœ€ç»ˆéªŒè¯
echo "âœ… æœ€ç»ˆéªŒè¯..."
./kernel_snapshot status | head -20
echo "ğŸ‰ æµ‹è¯•å®Œæˆï¼"
```

### 3. æ€§èƒ½ç›‘æ§

```bash
# åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬
cat > perf-test.sh << 'EOF'
#!/bin/bash

echo "ğŸ“Š æ€§èƒ½æµ‹è¯•å¼€å§‹..."

# æµ‹è¯•åˆ›å»ºé€Ÿåº¦
echo "ğŸ”„ æµ‹è¯•å¿«ç…§åˆ›å»ºé€Ÿåº¦..."
time ./kernel_snapshot create perf-test

# æµ‹è¯•çŠ¶æ€æ£€æŸ¥é€Ÿåº¦
echo "ğŸ”„ æµ‹è¯•çŠ¶æ€æ£€æŸ¥é€Ÿåº¦..."
time ./kernel_snapshot status

# æµ‹è¯•å¤§é‡æ–‡ä»¶å¤„ç†
echo "ğŸ”„ åˆ›å»ºå¤§é‡æµ‹è¯•æ–‡ä»¶..."
mkdir -p test-files
for i in {1..1000}; do
    echo "test file $i" > test-files/file$i.txt
done

echo "ğŸ”„ æµ‹è¯•å¤§é‡æ–‡ä»¶æ‰«æ..."
time ./kernel_snapshot status

# æ¸…ç†
rm -rf test-files
EOF

chmod +x perf-test.sh
./perf-test.sh
```

## ğŸ“‹ æœ€ä½³å®è·µæ€»ç»“

1. **é…ç½®æ–‡ä»¶æ”¾åœ¨å·¥å…·ç›®å½•**ï¼šä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œå›¢é˜Ÿå…±äº«
2. **åˆç†é…ç½®å¿½ç•¥æ¨¡å¼**ï¼šæ—¢è¦å¿½ç•¥æ— å…³æ–‡ä»¶ï¼Œåˆè¦é¿å…è¿‡åº¦å¿½ç•¥
3. **å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶**ï¼šä¿æŒå·¥ä½œç›®å½•æ•´æ´ï¼Œæé«˜æ‰«ææ€§èƒ½
4. **ç»“åˆ Git ä½¿ç”¨**ï¼šGit ç®¡ç†æºç ï¼ŒSnapshot ç›‘æ§å®Œæ•´çŠ¶æ€
5. **è‡ªåŠ¨åŒ–é›†æˆ**ï¼šå°† snapshot æ£€æŸ¥é›†æˆåˆ°æ„å»ºå’Œæµ‹è¯•æµç¨‹ä¸­

## ğŸ¯ æ€»ç»“

Kernel Snapshot å·¥å…·ä¸ºå†…æ ¸å¼€å‘æä¾›äº†å¼ºå¤§çš„æ–‡ä»¶çŠ¶æ€ç®¡ç†èƒ½åŠ›ï¼š

- **é›¶æ–‡ä»¶ä¸¢å¤±**ï¼šç¡®ä¿é‡è¦ä¿®æ”¹ä¸ä¼šè¢«é—æ¼
- **é«˜æ€§èƒ½**ï¼šæ™ºèƒ½ç´¢å¼•ç¼“å­˜æä¾› Git çº§åˆ«çš„é€Ÿåº¦
- **çµæ´»é…ç½®**ï¼šå…¨å±€é…ç½®æ–‡ä»¶æ”¯æŒå›¢é˜Ÿåä½œ
- **æ™ºèƒ½å¿½ç•¥**ï¼šé¿å…ä¸´æ—¶æ–‡ä»¶å¹²æ‰°ï¼Œä¸“æ³¨äºé‡è¦å˜æ›´

ç«‹å³å¼€å§‹ä½¿ç”¨ï¼Œä½“éªŒé«˜æ•ˆçš„å†…æ ¸å¼€å‘å·¥ä½œæµï¼ğŸš€