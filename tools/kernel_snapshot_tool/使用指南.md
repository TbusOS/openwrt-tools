# Kernel Snapshot 工具 - 详细使用指南

## 🎯 概述

Kernel Snapshot 是一个 Git 风格的文件快照工具，专为内核开发和大型代码库设计。支持智能索引缓存、文件忽略、全局配置等高级功能。

## 📋 快速开始

### 1. 基本使用步骤

```bash
# 步骤 1: 切换到您的项目目录
cd /path/to/your/kernel/source

# 步骤 2: 创建基线快照
./kernel_snapshot create linux-6.6

# 步骤 3: 修改代码文件
echo "// 新功能" >> drivers/new_feature.c

# 步骤 4: 查看变更
./kernel_snapshot status
```

### 2. 使用全局配置文件（推荐）

```bash
# 步骤 1: 创建全局配置文件
cat > .kernel_snapshot.conf << 'EOF'
# 默认工作目录（绝对路径）
default_workspace_dir=/home/user/linux-kernel-6.6

# 默认项目名称
default_project_name=linux-6.6-dev

# 忽略文件模式（用逗号分隔）
ignore_patterns=.git,*.tmp,*.log,*.bak,*.o,*.ko,build/,scripts/kconfig/.tmp*
EOF

# 步骤 2: 无需指定参数，直接创建
./kernel_snapshot create

# 步骤 3: 快速状态检查
./kernel_snapshot status
```

## ⚙️ 配置文件详解

### 配置文件位置

工具按以下优先级查找配置文件：

1. **工具所在目录**（推荐）：`/path/to/kernel_snapshot/.kernel_snapshot.conf`
2. **当前执行目录**：`./.kernel_snapshot.conf`
3. **用户主目录**：`~/.kernel_snapshot.conf`

### 完整配置文件示例

```ini
# kernel_snapshot 全局配置文件
# 此文件用于设置默认的工作目录和忽略模式

# ==========================================
# 基本配置
# ==========================================

# 默认工作目录（绝对路径）
# 如果设置，create 命令将默认在此目录创建快照
default_workspace_dir=/home/developer/projects/linux-kernel

# 默认项目名称
# 用于自动命名项目，如果命令行未指定
default_project_name=linux-mainline

# ==========================================
# 文件忽略配置
# ==========================================

# 忽略文件模式（用逗号分隔）
# 支持多种匹配模式：
ignore_patterns=.git,.snapshot,*.tmp,*.log,*.bak,*.o,*.ko,*.mod.c,build/,scripts/kconfig/.tmp*,Documentation/output/,arch/*/boot/compressed/vmlinux*

# ==========================================
# 高级配置示例
# ==========================================

# 针对不同项目类型的忽略模式示例：

# 内核开发项目：
# ignore_patterns=.git,*.o,*.ko,*.mod.c,*.tmp,*.log,build/,scripts/kconfig/.tmp*,vmlinux*,System.map,Module.symvers

# Web 开发项目：
# ignore_patterns=.git,node_modules/,*.log,*.tmp,dist/,build/,.env,coverage/

# C/C++ 项目：
# ignore_patterns=.git,*.o,*.obj,*.exe,*.dll,*.so,*.a,*.lib,build/,Debug/,Release/,*.tmp
```

### 忽略模式说明

支持的匹配模式：

| 模式类型 | 示例 | 说明 |
|---------|------|------|
| 后缀匹配 | `*.tmp`, `*.log`, `*.o` | 匹配特定扩展名的文件 |
| 前缀匹配 | `temp_*`, `backup_*` | 匹配特定前缀的文件 |
| 精确匹配 | `.git`, `node_modules` | 精确匹配文件或目录名 |
| 路径匹配 | `build/`, `scripts/tmp/` | 匹配包含特定路径的文件 |

## 🚀 实际使用场景

### 场景 1: 内核开发工作流

```bash
# 1. 设置内核开发环境
cd /usr/src/linux-6.6
./kernel_snapshot create kernel-6.6-base

# 2. 开发新功能
git checkout -b new-feature
# ... 修改代码 ...

# 3. 查看所有变更（包括未跟踪文件）
./kernel_snapshot status
# 输出示例：
# 🔍 差异分析报告:
# ================
# 🆕 新增的文件:
# A       drivers/gpu/new_driver.c
# A       include/linux/new_api.h
# 
# 📝 修改的文件:
# M       drivers/gpu/Makefile
# M       include/linux/module.h

# 4. 编译测试
make -j$(nproc)

# 5. 再次检查（编译产物会被自动忽略）
./kernel_snapshot status
```

### 场景 2: 多项目管理

```bash
# 配置文件支持动态切换项目
cat > project-switcher.sh << 'EOF'
#!/bin/bash

case "$1" in
    "kernel")
        echo "default_workspace_dir=/usr/src/linux-6.6" > .kernel_snapshot.conf
        echo "default_project_name=linux-6.6" >> .kernel_snapshot.conf
        ;;
    "uboot")
        echo "default_workspace_dir=/usr/src/u-boot" > .kernel_snapshot.conf
        echo "default_project_name=u-boot-dev" >> .kernel_snapshot.conf
        ;;
    "openwrt")
        echo "default_workspace_dir=/home/user/openwrt" > .kernel_snapshot.conf
        echo "default_project_name=openwrt-main" >> .kernel_snapshot.conf
        ;;
esac
echo "ignore_patterns=.git,*.o,*.tmp,*.log,build/" >> .kernel_snapshot.conf
EOF

chmod +x project-switcher.sh

# 使用方法
./project-switcher.sh kernel
./kernel_snapshot create

./project-switcher.sh openwrt  
./kernel_snapshot create
```

### 场景 3: 补丁开发工作流

```bash
# 1. 创建干净的基线
./kernel_snapshot create clean-base

# 2. 应用补丁并测试
patch -p1 < security-fix.patch

# 3. 查看补丁实际修改了什么
./kernel_snapshot status
# 可以看到所有被补丁修改的文件

# 4. 手动微调
vim drivers/affected_driver.c

# 5. 最终验证
./kernel_snapshot status
# 确认修改范围符合预期
```

## 📊 性能优化建议

### 1. 合理配置忽略模式

```bash
# ❌ 不好的配置 - 太宽泛
ignore_patterns=*

# ❌ 不好的配置 - 遗漏重要临时文件
ignore_patterns=.git

# ✅ 好的配置 - 精确且完整
ignore_patterns=.git,.snapshot,*.tmp,*.log,*.bak,*.o,*.ko,build/,scripts/kconfig/.tmp*
```

### 2. 索引缓存优化

```bash
# 大型项目首次创建会生成索引缓存
./kernel_snapshot create linux-huge-project

# 后续 status 检查会非常快速
time ./kernel_snapshot status
# 通常在几百毫秒内完成，即使对于有数万文件的项目
```

### 3. 多线程配置

```bash
# 对于大型项目，可以调整线程数
./kernel_snapshot create -t 16 huge-project

# 对于 SSD 存储，通常默认线程数已经足够
./kernel_snapshot create normal-project
```

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 配置文件未生效

```bash
# 检查配置文件位置
ls -la .kernel_snapshot.conf
ls -la ~/.kernel_snapshot.conf

# 验证配置文件格式
cat .kernel_snapshot.conf
# 确保没有多余的空格或特殊字符
```

#### 2. 文件忽略不生效

```bash
# 测试忽略模式
echo "测试" > test.tmp
./kernel_snapshot status
# 如果 test.tmp 出现在新增文件中，说明忽略模式有问题

# 检查模式语法
# ✅ 正确：*.tmp
# ❌ 错误：*.tmp*（会匹配 .tmpx 等意外文件）
```

#### 3. 性能问题

```bash
# 检查忽略的文件数量
find . -name "*.o" | wc -l
find . -name "*.tmp" | wc -l

# 如果临时文件很多，确保它们被正确忽略
grep -i "\.o\|\.tmp" .kernel_snapshot.conf
```

## 📈 高级用法

### 1. 结合 Git 使用

```bash
# Git 跟踪源码变更，Snapshot 跟踪完整状态
git status                    # 查看 Git 管理的变更
./kernel_snapshot status      # 查看所有文件变更（包括未跟踪文件）

# 场景：查看编译后的完整影响
make clean
./kernel_snapshot create before-build
make -j$(nproc)
./kernel_snapshot status      # 查看编译产生的文件
```

### 2. 自动化脚本集成

```bash
#!/bin/bash
# 自动化测试脚本示例

set -e

echo "🔄 开始自动化测试流程..."

# 1. 创建基线
./kernel_snapshot create test-baseline

# 2. 运行测试
echo "📝 应用测试补丁..."
patch -p1 < test.patch

# 3. 验证变更范围
echo "🔍 验证变更范围..."
CHANGES=$(./kernel_snapshot status | grep -E "^[AMD]" | wc -l)
if [ "$CHANGES" -gt 50 ]; then
    echo "⚠️  警告：变更文件过多 ($CHANGES 个文件)"
    exit 1
fi

# 4. 编译测试
echo "🔨 编译测试..."
make -j$(nproc)

# 5. 最终验证
echo "✅ 最终验证..."
./kernel_snapshot status | head -20
echo "🎉 测试完成！"
```

### 3. 性能监控

```bash
# 创建性能测试脚本
cat > perf-test.sh << 'EOF'
#!/bin/bash

echo "📊 性能测试开始..."

# 测试创建速度
echo "🔄 测试快照创建速度..."
time ./kernel_snapshot create perf-test

# 测试状态检查速度
echo "🔄 测试状态检查速度..."
time ./kernel_snapshot status

# 测试大量文件处理
echo "🔄 创建大量测试文件..."
mkdir -p test-files
for i in {1..1000}; do
    echo "test file $i" > test-files/file$i.txt
done

echo "🔄 测试大量文件扫描..."
time ./kernel_snapshot status

# 清理
rm -rf test-files
EOF

chmod +x perf-test.sh
./perf-test.sh
```

## 📋 最佳实践总结

1. **配置文件放在工具目录**：便于版本控制和团队共享
2. **合理配置忽略模式**：既要忽略无关文件，又要避免过度忽略
3. **定期清理临时文件**：保持工作目录整洁，提高扫描性能
4. **结合 Git 使用**：Git 管理源码，Snapshot 监控完整状态
5. **自动化集成**：将 snapshot 检查集成到构建和测试流程中

## 🎯 总结

Kernel Snapshot 工具为内核开发提供了强大的文件状态管理能力：

- **零文件丢失**：确保重要修改不会被遗漏
- **高性能**：智能索引缓存提供 Git 级别的速度
- **灵活配置**：全局配置文件支持团队协作
- **智能忽略**：避免临时文件干扰，专注于重要变更

立即开始使用，体验高效的内核开发工作流！🚀