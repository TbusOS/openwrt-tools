# Kernel Snapshot å·¥å…· - å¿«é€Ÿå¼€å§‹ç¤ºä¾‹

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥å…·å’Œé…ç½®

```bash
# 1. ç¡®ä¿å·¥å…·ç¼–è¯‘å®Œæˆ
cd /path/to/kernel_snapshot_tool
make clean && make

# 2. åˆ›å»ºå…¨å±€é…ç½®æ–‡ä»¶ï¼ˆæ¨èæ–¹å¼ï¼‰
cat > .kernel_snapshot.conf << 'EOF'
# é»˜è®¤å·¥ä½œç›®å½•ï¼ˆæ”¹ä¸ºä½ çš„å®é™…è·¯å¾„ï¼‰
default_workspace_dir=/home/user/linux-kernel-6.6

# é»˜è®¤é¡¹ç›®åç§°
default_project_name=linux-dev

# å¿½ç•¥æ–‡ä»¶æ¨¡å¼
ignore_patterns=.git,.snapshot,*.tmp,*.log,*.bak,*.o,*.ko,build/
EOF

# 3. éªŒè¯é…ç½®
./kernel_snapshot --help | grep -A 10 "å…¨å±€é…ç½®æ–‡ä»¶"
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç¬¬ä¸€ä¸ªå¿«ç…§

```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
./kernel_snapshot create
# è¾“å‡ºç¤ºä¾‹ï¼š
# ğŸ“– è¯»å–å…¨å±€é…ç½®æ–‡ä»¶: ./.kernel_snapshot.conf
# ğŸ”§ ä½¿ç”¨å…¨å±€é…ç½®çš„é»˜è®¤å·¥ä½œç›®å½•: /home/user/linux-kernel-6.6
# ğŸ”§ ä½¿ç”¨å…¨å±€é…ç½®çš„é»˜è®¤é¡¹ç›®å: linux-dev
# ğŸ¯ åˆå§‹åŒ–å·¥ä½œåŒº: linux-dev (ç›®å½•: /home/user/linux-kernel-6.6)
# ğŸ” å¼€å§‹åˆ›å»ºåŸºçº¿å¿«ç…§: /home/user/linux-kernel-6.6
# ğŸ”„ å¤„ç†æ–‡ä»¶...
# ğŸ“Š [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100.0% (15420/15420) å®Œæˆ
# âœ… å¿«ç…§åˆ›å»ºå®Œæˆ!
# ğŸ“Š å¤„ç†æ‘˜è¦: 15420/15420 æ–‡ä»¶ (100.0%), è€—æ—¶: 2340 ms

# æ–¹å¼ 2ï¼šæ‰‹åŠ¨æŒ‡å®šï¼ˆå¦‚æœæ²¡æœ‰é…ç½®æ–‡ä»¶ï¼‰
./kernel_snapshot create /path/to/your/project my-project
```

### ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿå¼€å‘åœºæ™¯

```bash
# 1. åˆ‡æ¢åˆ°å·¥ä½œç›®å½•ï¼ˆå¦‚æœä½¿ç”¨äº†é…ç½®æ–‡ä»¶ï¼Œå·¥å…·å·²ç»åœ¨æ­£ç¡®çš„ç›®å½•å·¥ä½œï¼‰
cd /home/user/linux-kernel-6.6

# 2. æ¨¡æ‹Ÿä¸€äº›ä»£ç ä¿®æ”¹
echo "// æ–°åŠŸèƒ½å®ç°" >> drivers/gpu/drm/new_feature.c
echo "æ–°çš„é…ç½®é€‰é¡¹" >> kernel/Kconfig.new
echo "ä¸´æ—¶è°ƒè¯•ä¿¡æ¯" >> debug.tmp

# 3. æŸ¥çœ‹å˜æ›´
/path/to/kernel_snapshot_tool/kernel_snapshot status
# è¾“å‡ºç¤ºä¾‹ï¼š
# ğŸ” æ£€æŸ¥å·¥ä½œåŒºçŠ¶æ€ (åŸºäºåŸºçº¿å¿«ç…§)
# ğŸš€ Gité£æ ¼å¿«é€ŸçŠ¶æ€æ£€æŸ¥ (ä½¿ç”¨ç´¢å¼•ç¼“å­˜)...
# âœ… ç´¢å¼•è½½å…¥å®Œæˆï¼ŒåŒ…å« 15420 ä¸ªæ–‡ä»¶
# ğŸ” å¼€å§‹å¿«é€Ÿæ‰«æ...
# 
# ğŸ” å·®å¼‚åˆ†ææŠ¥å‘Š:
# ================
# 
# ğŸ†• æ–°å¢çš„æ–‡ä»¶:
# A       drivers/gpu/drm/new_feature.c
# A       kernel/Kconfig.new
# 
# ğŸ“Š çŠ¶æ€æ£€æŸ¥å®Œæˆ!
# ================
# ğŸ§® å“ˆå¸Œè®¡ç®—: 0 (ä»… 0.0% çš„æ–‡ä»¶)
# 
# ğŸ“ˆ å˜æ›´ç»Ÿè®¡:
#   ğŸ†• æ–°å¢æ–‡ä»¶: 2
#   âœï¸  ä¿®æ”¹æ–‡ä»¶: 0
#   ğŸ—‘ï¸  åˆ é™¤æ–‡ä»¶: 0
#   âœ… æœªå˜æ›´: 15420
#   ğŸ“Š æ€»å˜æ›´: 2
```

æ³¨æ„ï¼š`debug.tmp` æ–‡ä»¶æ²¡æœ‰æ˜¾ç¤ºï¼Œå› ä¸ºå®ƒè¢«é…ç½®æ–‡ä»¶ä¸­çš„ `*.tmp` æ¨¡å¼å¿½ç•¥äº†ï¼

## ğŸ“‹ å®Œæ•´çš„å¼€å‘å·¥ä½œæµç¤ºä¾‹

### åœºæ™¯ï¼šLinux å†…æ ¸é©±åŠ¨å¼€å‘

```bash
# ===== ç¯å¢ƒå‡†å¤‡ =====
cd /usr/src/linux-6.6

# åˆ›å»ºé’ˆå¯¹å†…æ ¸å¼€å‘çš„é…ç½®æ–‡ä»¶
cat > /path/to/kernel_snapshot_tool/.kernel_snapshot.conf << 'EOF'
default_workspace_dir=/usr/src/linux-6.6
default_project_name=kernel-6.6-driver-dev
ignore_patterns=.git,.snapshot,*.o,*.ko,*.mod.c,*.tmp,*.log,*.bak,build/,scripts/kconfig/.tmp*,vmlinux*,System.map,Module.symvers
EOF

# ===== ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåŸºçº¿ =====
echo "ğŸ”„ æ­¥éª¤ 1: åˆ›å»ºå¹²å‡€çš„åŸºçº¿å¿«ç…§..."
/path/to/kernel_snapshot_tool/kernel_snapshot create

# ===== ç¬¬äºŒæ­¥ï¼šå¼€å§‹å¼€å‘ =====
echo "ğŸ”„ æ­¥éª¤ 2: å¼€å§‹é©±åŠ¨å¼€å‘..."

# åˆ›å»ºæ–°çš„é©±åŠ¨æ–‡ä»¶
mkdir -p drivers/custom
cat > drivers/custom/my_driver.c << 'EOF'
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>

static int __init my_driver_init(void)
{
    printk(KERN_INFO "My driver loaded\n");
    return 0;
}

static void __exit my_driver_exit(void)
{
    printk(KERN_INFO "My driver unloaded\n");
}

module_init(my_driver_init);
module_exit(my_driver_exit);
MODULE_LICENSE("GPL");
MODULE_DESCRIPTION("My Custom Driver");
EOF

# ä¿®æ”¹ Kconfig æ·»åŠ é…ç½®é€‰é¡¹
cat >> drivers/custom/Kconfig << 'EOF'
config MY_CUSTOM_DRIVER
    tristate "My Custom Driver"
    help
      This is my custom driver for demonstration.
EOF

# ä¿®æ”¹ Makefile
cat > drivers/custom/Makefile << 'EOF'
obj-$(CONFIG_MY_CUSTOM_DRIVER) += my_driver.o
EOF

# æ›´æ–°ä¸Šçº§ Makefile
echo "obj-\$(CONFIG_MY_CUSTOM_DRIVER) += custom/" >> drivers/Makefile

# ===== ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥å˜æ›´ =====
echo "ğŸ”„ æ­¥éª¤ 3: æ£€æŸ¥å¼€å‘è¿›åº¦..."
/path/to/kernel_snapshot_tool/kernel_snapshot status

# é¢„æœŸè¾“å‡ºï¼š
# ğŸ†• æ–°å¢çš„æ–‡ä»¶:
# A       drivers/custom/my_driver.c
# A       drivers/custom/Kconfig  
# A       drivers/custom/Makefile
# 
# ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶:
# M       drivers/Makefile

# ===== ç¬¬å››æ­¥ï¼šç¼–è¯‘æµ‹è¯• =====
echo "ğŸ”„ æ­¥éª¤ 4: ç¼–è¯‘æµ‹è¯•..."
make oldconfig
make drivers/custom/my_driver.ko

# ===== ç¬¬äº”æ­¥ï¼šæ£€æŸ¥ç¼–è¯‘äº§ç‰© =====
echo "ğŸ”„ æ­¥éª¤ 5: æ£€æŸ¥ç¼–è¯‘åçš„çŠ¶æ€..."
/path/to/kernel_snapshot_tool/kernel_snapshot status

# æ³¨æ„ï¼šç¼–è¯‘äº§ç‰©ï¼ˆ*.o, *.ko ç­‰ï¼‰ä¸ä¼šæ˜¾ç¤ºï¼Œå› ä¸ºè¢«å¿½ç•¥äº†
# åªä¼šçœ‹åˆ°æºç çº§åˆ«çš„å˜æ›´

# ===== ç¬¬å…­æ­¥ï¼šç»§ç»­å¼€å‘ =====
echo "ğŸ”„ æ­¥éª¤ 6: æ·»åŠ æ›´å¤šåŠŸèƒ½..."

# æ·»åŠ è®¾å¤‡æ–‡ä»¶æ“ä½œ
cat >> drivers/custom/my_driver.c << 'EOF'

#include <linux/fs.h>
#include <linux/device.h>
#include <linux/cdev.h>

static dev_t dev_num;
static struct class *my_class;
static struct device *my_device;
static struct cdev my_cdev;

static int my_open(struct inode *inode, struct file *file)
{
    printk(KERN_INFO "Device opened\n");
    return 0;
}

static int my_release(struct inode *inode, struct file *file)
{
    printk(KERN_INFO "Device closed\n");
    return 0;
}

static const struct file_operations my_fops = {
    .owner = THIS_MODULE,
    .open = my_open,
    .release = my_release,
};
EOF

# ===== ç¬¬ä¸ƒæ­¥ï¼šæœ€ç»ˆæ£€æŸ¥ =====
echo "ğŸ”„ æ­¥éª¤ 7: æœ€ç»ˆå¼€å‘çŠ¶æ€æ£€æŸ¥..."
/path/to/kernel_snapshot_tool/kernel_snapshot status

# æœ€ç»ˆè¾“å‡ºç¤ºä¾‹ï¼š
# ğŸ” å·®å¼‚åˆ†ææŠ¥å‘Š:
# ================
# 
# ğŸ†• æ–°å¢çš„æ–‡ä»¶:
# A       drivers/custom/my_driver.c
# A       drivers/custom/Kconfig
# A       drivers/custom/Makefile
# 
# ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶:
# M       drivers/Makefile
# 
# ğŸ“Š çŠ¶æ€æ£€æŸ¥å®Œæˆ!
# ================
# ğŸ“ˆ å˜æ›´ç»Ÿè®¡:
#   ğŸ†• æ–°å¢æ–‡ä»¶: 3
#   âœï¸  ä¿®æ”¹æ–‡ä»¶: 1
#   ğŸ—‘ï¸  åˆ é™¤æ–‡ä»¶: 0
#   âœ… æœªå˜æ›´: 67234
#   ğŸ“Š æ€»å˜æ›´: 4

echo "âœ… å¼€å‘å®Œæˆï¼æˆåŠŸè·Ÿè¸ªäº†æ‰€æœ‰æºç çº§åˆ«çš„å˜æ›´ã€‚"
```

## ğŸ”§ å¸¸ç”¨æ“ä½œç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå¿«é€Ÿåˆ‡æ¢é¡¹ç›®

```bash
#!/bin/bash
# é¡¹ç›®åˆ‡æ¢è„šæœ¬

switch_project() {
    case "$1" in
        "kernel")
            cat > .kernel_snapshot.conf << 'EOF'
default_workspace_dir=/usr/src/linux-6.6
default_project_name=kernel-dev
ignore_patterns=.git,.snapshot,*.o,*.ko,*.tmp,*.log,build/
EOF
            ;;
        "uboot")
            cat > .kernel_snapshot.conf << 'EOF'
default_workspace_dir=/home/user/u-boot
default_project_name=uboot-dev
ignore_patterns=.git,.snapshot,*.o,*.bin,*.elf,*.tmp,*.log
EOF
            ;;
        "openwrt")
            cat > .kernel_snapshot.conf << 'EOF'
default_workspace_dir=/home/user/openwrt
default_project_name=openwrt-dev
ignore_patterns=.git,.snapshot,build_dir/,staging_dir/,tmp/,*.tmp,*.log
EOF
            ;;
        *)
            echo "ç”¨æ³•: switch_project [kernel|uboot|openwrt]"
            return 1
            ;;
    esac
    echo "âœ… å·²åˆ‡æ¢åˆ° $1 é¡¹ç›®é…ç½®"
    echo "ğŸ“‹ å½“å‰é…ç½®ï¼š"
    cat .kernel_snapshot.conf
}

# ä½¿ç”¨ç¤ºä¾‹
switch_project kernel
./kernel_snapshot create

switch_project openwrt
./kernel_snapshot create
```

### ç¤ºä¾‹ 2ï¼šè‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬

```bash
#!/bin/bash
# è¡¥ä¸éªŒè¯è„šæœ¬

set -e

PATCH_FILE="$1"
if [[ -z "$PATCH_FILE" ]]; then
    echo "ç”¨æ³•: $0 <è¡¥ä¸æ–‡ä»¶>"
    exit 1
fi

echo "ğŸ”„ å¼€å§‹è¡¥ä¸éªŒè¯æµç¨‹..."

# 1. åˆ›å»ºåŸºçº¿
echo "ğŸ“¸ åˆ›å»ºåº”ç”¨è¡¥ä¸å‰çš„åŸºçº¿..."
./kernel_snapshot create patch-test-baseline

# 2. åº”ç”¨è¡¥ä¸
echo "ğŸ“ åº”ç”¨è¡¥ä¸: $PATCH_FILE"
patch -p1 < "$PATCH_FILE"

# 3. æ£€æŸ¥å½±å“èŒƒå›´
echo "ğŸ” åˆ†æè¡¥ä¸å½±å“èŒƒå›´..."
CHANGES_OUTPUT=$(./kernel_snapshot status)
echo "$CHANGES_OUTPUT"

# 4. ç»Ÿè®¡å˜æ›´
MODIFIED_COUNT=$(echo "$CHANGES_OUTPUT" | grep -c "^M" || true)
ADDED_COUNT=$(echo "$CHANGES_OUTPUT" | grep -c "^A" || true)
DELETED_COUNT=$(echo "$CHANGES_OUTPUT" | grep -c "^D" || true)

echo ""
echo "ğŸ“Š è¡¥ä¸å½±å“ç»Ÿè®¡ï¼š"
echo "   ä¿®æ”¹æ–‡ä»¶: $MODIFIED_COUNT"
echo "   æ–°å¢æ–‡ä»¶: $ADDED_COUNT"  
echo "   åˆ é™¤æ–‡ä»¶: $DELETED_COUNT"

# 5. å®‰å…¨æ£€æŸ¥
TOTAL_CHANGES=$((MODIFIED_COUNT + ADDED_COUNT + DELETED_COUNT))
if [[ $TOTAL_CHANGES -gt 50 ]]; then
    echo "âš ï¸  è­¦å‘Šï¼šå˜æ›´æ–‡ä»¶è¿‡å¤š ($TOTAL_CHANGES ä¸ª)ï¼Œè¯·ä»”ç»†æ£€æŸ¥"
elif [[ $TOTAL_CHANGES -eq 0 ]]; then
    echo "âš ï¸  è­¦å‘Šï¼šè¡¥ä¸ä¼¼ä¹æ²¡æœ‰äº§ç”Ÿä»»ä½•å˜æ›´"
else
    echo "âœ… å˜æ›´èŒƒå›´åˆç† ($TOTAL_CHANGES ä¸ªæ–‡ä»¶)"
fi

# 6. ç¼–è¯‘æµ‹è¯•
echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘æµ‹è¯•..."
if make -j$(nproc) > build.log 2>&1; then
    echo "âœ… ç¼–è¯‘æˆåŠŸ"
else
    echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ build.log"
    exit 1
fi

echo "ğŸ‰ è¡¥ä¸éªŒè¯å®Œæˆï¼"
```

### ç¤ºä¾‹ 3ï¼šæ€§èƒ½æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# æ€§èƒ½æµ‹è¯•è„šæœ¬

echo "ğŸ“Š Kernel Snapshot æ€§èƒ½æµ‹è¯•"
echo "=========================="

# æµ‹è¯•ä¸åŒå¤§å°çš„é¡¹ç›®
test_performance() {
    local project_name="$1"
    local project_path="$2"
    
    echo ""
    echo "ğŸ”„ æµ‹è¯•é¡¹ç›®: $project_name"
    echo "ğŸ“ è·¯å¾„: $project_path"
    
    # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
    FILE_COUNT=$(find "$project_path" -type f | wc -l)
    echo "ğŸ“‹ æ–‡ä»¶æ€»æ•°: $FILE_COUNT"
    
    # æµ‹è¯•åˆ›å»ºå¿«ç…§
    echo "â±ï¸  æµ‹è¯•å¿«ç…§åˆ›å»º..."
    START_TIME=$(date +%s.%N)
    ./kernel_snapshot create "$project_path" "perf-test-$project_name"
    END_TIME=$(date +%s.%N)
    CREATE_TIME=$(echo "$END_TIME - $START_TIME" | bc)
    echo "   â±ï¸  åˆ›å»ºæ—¶é—´: ${CREATE_TIME}s"
    
    # æµ‹è¯•çŠ¶æ€æ£€æŸ¥
    echo "â±ï¸  æµ‹è¯•çŠ¶æ€æ£€æŸ¥..."
    START_TIME=$(date +%s.%N)
    ./kernel_snapshot status > /dev/null
    END_TIME=$(date +%s.%N)
    STATUS_TIME=$(echo "$END_TIME - $START_TIME" | bc)
    echo "   â±ï¸  çŠ¶æ€æ£€æŸ¥æ—¶é—´: ${STATUS_TIME}s"
    
    # è®¡ç®—æ€§èƒ½æŒ‡æ ‡
    if (( $(echo "$CREATE_TIME > 0" | bc -l) )); then
        CREATE_RATE=$(echo "scale=2; $FILE_COUNT / $CREATE_TIME" | bc)
        echo "   ğŸ“ˆ åˆ›å»ºé€Ÿåº¦: ${CREATE_RATE} æ–‡ä»¶/ç§’"
    fi
    
    if (( $(echo "$STATUS_TIME > 0" | bc -l) )); then
        STATUS_RATE=$(echo "scale=2; $FILE_COUNT / $STATUS_TIME" | bc)
        echo "   ğŸ“ˆ æ£€æŸ¥é€Ÿåº¦: ${STATUS_RATE} æ–‡ä»¶/ç§’"
    fi
}

# è¿è¡Œæµ‹è¯•
test_performance "small" "/usr/include"
test_performance "medium" "/usr/src/linux-headers-$(uname -r)"
test_performance "large" "/usr/src/linux-6.6"

echo ""
echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆï¼"
```

## ğŸ¯ æ€»ç»“

é€šè¿‡è¿™äº›ç¤ºä¾‹ï¼Œä½ å·²ç»å­¦ä¼šäº†ï¼š

1. **åŸºæœ¬é…ç½®**ï¼šåˆ›å»ºå’Œä½¿ç”¨å…¨å±€é…ç½®æ–‡ä»¶
2. **å¼€å‘å·¥ä½œæµ**ï¼šä»åˆ›å»ºåŸºçº¿åˆ°è·Ÿè¸ªå˜æ›´çš„å®Œæ•´æµç¨‹
3. **é«˜çº§ç”¨æ³•**ï¼šé¡¹ç›®åˆ‡æ¢ã€è‡ªåŠ¨åŒ–éªŒè¯ã€æ€§èƒ½æµ‹è¯•
4. **æœ€ä½³å®è·µ**ï¼šåˆç†çš„å¿½ç•¥æ¨¡å¼å’Œå·¥ä½œæµé›†æˆ

ç«‹å³å¼€å§‹ä½¿ç”¨ Kernel Snapshot å·¥å…·ï¼Œä½“éªŒé«˜æ•ˆçš„å†…æ ¸å¼€å‘ï¼ğŸš€

## ğŸ“ è·å–å¸®åŠ©

```bash
# æŸ¥çœ‹å®Œæ•´å¸®åŠ©ä¿¡æ¯
./kernel_snapshot --help

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
./kernel_snapshot --version

# ä½¿ç”¨è¯¦ç»†æ¨¡å¼è¿›è¡Œè°ƒè¯•
./kernel_snapshot -v create
./kernel_snapshot -v status
```

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. é…ç½®æ–‡ä»¶è·¯å¾„å’Œæ ¼å¼
2. å·¥ä½œç›®å½•æƒé™
3. å¿½ç•¥æ¨¡å¼è¯­æ³•
4. æ–‡ä»¶ç³»ç»Ÿç©ºé—´