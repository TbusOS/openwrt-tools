# å†…æ ¸å¿«ç…§å·¥å…· Makefile
# ä¸“ä¸ºOpenWrtå†…æ ¸å¼€å‘ä¼˜åŒ–çš„é«˜æ€§èƒ½å¿«ç…§ç³»ç»Ÿ

# ç¼–è¯‘å™¨å’Œå·¥å…·
CC = gcc
STRIP = strip

# é¡¹ç›®ä¿¡æ¯
PROGRAM = kernel_snapshot
VERSION = 1.1.1
TARGET_DIR = /usr/local/bin

# æºæ–‡ä»¶
SRCS = main.c \
       snapshot_core.c \
       snapshot_diff.c \
       index_cache_simple.c \
       progress_bar.c

OBJS = $(SRCS:.c=.o)

# ç¼–è¯‘æ ‡å¿—
CFLAGS = -std=c99 -Wall -Wextra -O3 -march=native \
         -flto -ffast-math -funroll-loops -finline-functions \
         -D_GNU_SOURCE -D_POSIX_C_SOURCE=200809L \
         -DVERSION=\"$(VERSION)\"

LDFLAGS = -lpthread

# è°ƒè¯•æ ‡å¿—
DEBUG_CFLAGS = -std=c99 -Wall -Wextra -g -O0 -DDEBUG \
               -fsanitize=address -fno-omit-frame-pointer \
               -D_GNU_SOURCE -D_POSIX_C_SOURCE=200809L \
               -DVERSION=\"$(VERSION)-debug\"

DEBUG_LDFLAGS = -lpthread -fsanitize=address

# é»˜è®¤ç›®æ ‡
all: $(PROGRAM)

# ä¸»ç¨‹åº
$(PROGRAM): $(OBJS)
	@echo "ğŸ”— é“¾æ¥ $(PROGRAM)..."
	$(CC) -o $@ $(OBJS) $(LDFLAGS)
	$(STRIP) $@
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(PROGRAM)"

# ç¼–è¯‘ç›®æ ‡æ–‡ä»¶
%.o: %.c
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CC) $(CFLAGS) -c $< -o $@

# è°ƒè¯•ç‰ˆæœ¬
debug: CFLAGS = $(DEBUG_CFLAGS)
debug: LDFLAGS = $(DEBUG_LDFLAGS)
debug: $(PROGRAM)_debug

$(PROGRAM)_debug: $(SRCS)
	@echo "ğŸ› ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬..."
	$(CC) $(DEBUG_CFLAGS) $(SRCS) $(DEBUG_LDFLAGS) -o $@
	@echo "âœ… è°ƒè¯•ç‰ˆæœ¬å®Œæˆ: $(PROGRAM)_debug"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f $(OBJS) $(PROGRAM) $(PROGRAM)_debug
	rm -f test_*.snapshot *.log

# å®‰è£…
install: $(PROGRAM)
	@echo "ğŸ“¦ å®‰è£… $(PROGRAM) åˆ° $(TARGET_DIR)..."
	sudo mkdir -p $(TARGET_DIR)
	sudo cp $(PROGRAM) $(TARGET_DIR)/
	sudo chmod 755 $(TARGET_DIR)/$(PROGRAM)
	@echo "âœ… å®‰è£…å®Œæˆ"

# å¸è½½
uninstall:
	@echo "ğŸ—‘ï¸ å¸è½½ $(PROGRAM)..."
	sudo rm -f $(TARGET_DIR)/$(PROGRAM)
	@echo "âœ… å¸è½½å®Œæˆ"

# æµ‹è¯•
test: $(PROGRAM)
	@echo "ğŸ§ª è¿è¡ŒåŸºæœ¬æµ‹è¯•..."
	@echo "1. åˆ›å»ºæµ‹è¯•ç›®å½•..."
	@mkdir -p test_data
	@echo "test file 1" > test_data/file1.txt
	@echo "test file 2" > test_data/file2.txt
	@echo "2. åˆ›å»ºå¿«ç…§..."
	@./$(PROGRAM) create test_data test1.snapshot
	@echo "3. ä¿®æ”¹æ–‡ä»¶..."
	@echo "modified" >> test_data/file1.txt
	@echo "new file" > test_data/file3.txt
	@echo "4. åˆ›å»ºç¬¬äºŒä¸ªå¿«ç…§..."
	@./$(PROGRAM) create test_data test2.snapshot
	@echo "5. å¯¹æ¯”å¿«ç…§..."
	@./$(PROGRAM) diff test1.snapshot test2.snapshot
	@echo "6. æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
	@rm -rf test_data test1.snapshot test2.snapshot
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# æ€§èƒ½æµ‹è¯•
benchmark: $(PROGRAM)
	@echo "âš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•..."
	@echo "æ­£åœ¨æµ‹è¯•å¤§å‹ç›®å½•..."
	@time ./$(PROGRAM) create /usr/include benchmark.snapshot || echo "è¯·é€‰æ‹©å…¶ä»–ç›®å½•è¿›è¡Œæµ‹è¯•"
	@rm -f benchmark.snapshot
	@echo "âœ… åŸºå‡†æµ‹è¯•å®Œæˆ"

# ä»£ç æ ¼å¼åŒ–ï¼ˆéœ€è¦clang-formatï¼‰
format:
	@echo "ğŸ“ æ ¼å¼åŒ–ä»£ç ..."
	@which clang-format > /dev/null && \
		clang-format -i -style="{BasedOnStyle: Linux, IndentWidth: 4}" $(SRCS) *.h || \
		echo "âš ï¸ æœªæ‰¾åˆ°clang-formatï¼Œè·³è¿‡æ ¼å¼åŒ–"

# é™æ€åˆ†æï¼ˆéœ€è¦cppcheckï¼‰
analyze:
	@echo "ğŸ” é™æ€ä»£ç åˆ†æ..."
	@which cppcheck > /dev/null && \
		cppcheck --enable=all --suppress=missingIncludeSystem $(SRCS) || \
		echo "âš ï¸ æœªæ‰¾åˆ°cppcheckï¼Œè·³è¿‡é™æ€åˆ†æ"

# æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "å†…æ ¸å¿«ç…§å·¥å…·ç¼–è¯‘é€‰é¡¹:"
	@echo "  make        - ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬"
	@echo "  make debug  - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  make test   - è¿è¡Œæµ‹è¯•"
	@echo "  make benchmark - æ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  make install   - å®‰è£…åˆ°ç³»ç»Ÿ"
	@echo "  make uninstall - ä»ç³»ç»Ÿå¸è½½"
	@echo "  make clean     - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make format    - æ ¼å¼åŒ–ä»£ç "
	@echo "  make analyze   - é™æ€ä»£ç åˆ†æ"
	@echo "  make help      - æ˜¾ç¤ºæ­¤å¸®åŠ©"

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
version:
	@echo "å†…æ ¸å¿«ç…§å·¥å…· v$(VERSION)"
	@echo "ä¸ºOpenWrtå†…æ ¸å¼€å‘ä¼˜åŒ–çš„é«˜æ€§èƒ½å¿«ç…§ç³»ç»Ÿ"

.PHONY: all debug clean install uninstall test benchmark format analyze help version