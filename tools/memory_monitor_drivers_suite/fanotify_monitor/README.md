# Linux fanotify æ–‡ä»¶è®¿é—®ç›‘æ§å·¥å…·

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºLinux `fanotify`ï¼ˆæ–‡ä»¶è®¿é—®é€šçŸ¥ï¼‰æœºåˆ¶çš„é«˜çº§æ–‡ä»¶ç›‘æ§å·¥å…·ï¼Œæä¾›ç³»ç»Ÿçº§çš„æ–‡ä»¶è®¿é—®ç›‘æ§åŠŸèƒ½ã€‚ä¸ä¼ ç»Ÿçš„`inotify`ç›¸æ¯”ï¼Œ`fanotify`æä¾›äº†æ›´å¼ºå¤§çš„ç›‘æ§èƒ½åŠ›å’Œæƒé™æ§åˆ¶åŠŸèƒ½ã€‚

## ç‰¹æ€§

- ğŸ” **ç³»ç»Ÿçº§ç›‘æ§**ï¼šç›‘æ§æ•´ä¸ªæŒ‚è½½ç‚¹çš„æ–‡ä»¶è®¿é—®
- ğŸ‘ï¸ **ç²¾ç¡®äº‹ä»¶**ï¼šä¸ä¼šä¸¢å¤±æ–‡ä»¶è®¿é—®äº‹ä»¶
- ğŸ›¡ï¸ **æƒé™æ§åˆ¶**ï¼šæ”¯æŒé˜»æ­¢æˆ–å…è®¸æ–‡ä»¶è®¿é—®
- ğŸ“Š **è¿›ç¨‹ä¿¡æ¯**ï¼šæ˜¾ç¤ºè®¿é—®æ–‡ä»¶çš„è¿›ç¨‹PID
- âš¡ **é«˜æ€§èƒ½**ï¼šé€‚åˆå®‰å…¨å®¡è®¡å’Œç³»ç»Ÿç›‘æ§

## ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinux 2.6.37+ (æ¨è3.8+)
- **æƒé™**ï¼šrootç”¨æˆ·æˆ–CAP_SYS_ADMINæƒé™
- **å†…æ ¸æ”¯æŒ**ï¼šCONFIG_FANOTIFY=y

## ç¼–è¯‘å’Œå®‰è£…

### å¿«é€Ÿç¼–è¯‘
```bash
make
```

### æ‰‹åŠ¨ç¼–è¯‘
```bash
gcc -o fanotify_demo fanotify_demo.c
```

### æ£€æŸ¥ç³»ç»Ÿæ”¯æŒ
```bash
# æ£€æŸ¥å†…æ ¸æ˜¯å¦æ”¯æŒfanotify
grep -q "CONFIG_FANOTIFY=y" /boot/config-$(uname -r) && echo "æ”¯æŒfanotify" || echo "ä¸æ”¯æŒfanotify"

# æ£€æŸ¥å½“å‰æƒé™
id -u
# å¦‚æœè¾“å‡º0ï¼Œè¡¨ç¤ºæœ‰rootæƒé™
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•
```bash
# ç›‘æ§æŒ‡å®šç›®å½•ï¼ˆéœ€è¦rootæƒé™ï¼‰
sudo ./fanotify_demo /path/to/monitor

# ç›‘æ§å½“å‰ç›®å½•
sudo ./fanotify_demo .

# ç›‘æ§æ•´ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
sudo ./fanotify_demo /
```

### å®é™…ä½¿ç”¨ç¤ºä¾‹

#### 1. ç›‘æ§å¼€å‘ç›®å½•
```bash
# ç›‘æ§å†…æ ¸æºç ç›®å½•çš„æ–‡ä»¶è®¿é—®
sudo ./fanotify_demo /usr/src/linux
```

#### 2. å®‰å…¨å®¡è®¡
```bash
# ç›‘æ§é‡è¦ç³»ç»Ÿç›®å½•
sudo ./fanotify_demo /etc
sudo ./fanotify_demo /usr/bin
```

#### 3. è°ƒè¯•æ–‡ä»¶è®¿é—®
```bash
# ç›‘æ§åº”ç”¨ç¨‹åºçš„æ–‡ä»¶è®¿é—®æ¨¡å¼
sudo ./fanotify_demo /home/user/app_data
```

## è¾“å‡ºç¤ºä¾‹

```
ğŸš€ fanotify æ–‡ä»¶ç›‘æ§å¯åŠ¨
=========================
ç›‘æ§è·¯å¾„: /home/user/test
æƒé™: root (CAP_SYS_ADMIN)
ç›‘æ§äº‹ä»¶: OPEN, CLOSE, ACCESS, MODIFY
(æŒ‰ Ctrl+C åœæ­¢ç›‘æ§)

âœ… fanotify ç›‘æ§å·²å¯åŠ¨

[14:30:15] ğŸ“ OPEN /home/user/test/file.txt (PID: 1234)
[14:30:15] ğŸ“ ACCESS /home/user/test/file.txt (PID: 1234)
[14:30:15] ğŸ“ CLOSE_NOWRITE /home/user/test/file.txt (PID: 1234)
[14:30:20] ğŸ“ OPEN /home/user/test/config.cfg (PID: 5678)
[14:30:20] ğŸ“ MODIFY /home/user/test/config.cfg (PID: 5678)
[14:30:20] ğŸ“ CLOSE_WRITE /home/user/test/config.cfg (PID: 5678)

ğŸ›‘ fanotify ç›‘æ§å·²åœæ­¢

ğŸ“Š ç›‘æ§ç»Ÿè®¡
===========
æ€»äº‹ä»¶æ•°: 6
```

## äº‹ä»¶ç±»å‹è¯´æ˜

| äº‹ä»¶ç±»å‹ | æè¿° |
|----------|------|
| **OPEN** | æ–‡ä»¶è¢«æ‰“å¼€ |
| **ACCESS** | æ–‡ä»¶è¢«è¯»å– |
| **MODIFY** | æ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹ |
| **CLOSE_WRITE** | ä»¥å†™å…¥æ¨¡å¼æ‰“å¼€çš„æ–‡ä»¶è¢«å…³é—­ |
| **CLOSE_NOWRITE** | ä»¥åªè¯»æ¨¡å¼æ‰“å¼€çš„æ–‡ä»¶è¢«å…³é—­ |
| **OPEN_PERM** | æ–‡ä»¶æ‰“å¼€æƒé™æ£€æŸ¥ |
| **ACCESS_PERM** | æ–‡ä»¶è®¿é—®æƒé™æ£€æŸ¥ |

## ä¸inotifyçš„å¯¹æ¯”

è¯¦ç»†çš„æŠ€æœ¯å¯¹æ¯”è¯·å‚è€ƒï¼š[MONITORING_COMPARISON.md](./MONITORING_COMPARISON.md)

| ç‰¹æ€§ | fanotify | inotify |
|------|----------|---------|
| **æƒé™è¦æ±‚** | root/CAP_SYS_ADMIN | æ™®é€šç”¨æˆ· |
| **ç›‘æ§èŒƒå›´** | æ•´ä¸ªæŒ‚è½½ç‚¹ | æŒ‡å®šç›®å½• |
| **äº‹ä»¶ç²¾åº¦** | ä¸ä¸¢å¤± | å¯èƒ½ä¸¢å¤± |
| **æƒé™æ§åˆ¶** | æ”¯æŒ | ä¸æ”¯æŒ |
| **èµ„æºå ç”¨** | ä¸­é«˜ | ä½ |
| **é€‚ç”¨åœºæ™¯** | å®‰å…¨å®¡è®¡ã€ç³»ç»Ÿç›‘æ§ | å¼€å‘å·¥å…·ã€ç”¨æˆ·åº”ç”¨ |

## å®‰å…¨æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š
1. **æƒé™æ•æ„Ÿ**ï¼šfanotifyéœ€è¦rootæƒé™ï¼Œä½¿ç”¨æ—¶è¦è°¨æ…
2. **æ€§èƒ½å½±å“**ï¼šç›‘æ§å¤§èŒƒå›´ç›®å½•å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½
3. **äº‹ä»¶æ´ªæµ**ï¼šç›‘æ§æ´»è·ƒç›®å½•ä¼šäº§ç”Ÿå¤§é‡äº‹ä»¶
4. **æƒé™æ§åˆ¶**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§

## æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯

#### 1. æƒé™é”™è¯¯
```
é”™è¯¯: fanotify éœ€è¦rootæƒé™
è¯·ä½¿ç”¨: sudo ./fanotify_demo /path
```
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨sudoè¿è¡Œæˆ–åˆ‡æ¢åˆ°rootç”¨æˆ·

#### 2. å†…æ ¸ä¸æ”¯æŒ
```
fanotify_init: Function not implemented
æç¤º: ç¡®ä¿å†…æ ¸æ”¯æŒfanotifyä¸”æ‹¥æœ‰rootæƒé™
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ï¼š`uname -r`
- æ£€æŸ¥å†…æ ¸é…ç½®ï¼š`grep FANOTIFY /boot/config-$(uname -r)`
- å‡çº§åˆ°æ”¯æŒfanotifyçš„å†…æ ¸ç‰ˆæœ¬

#### 3. èµ„æºä¸è¶³
```
fanotify_mark: No space left on device
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥inotifyé™åˆ¶ï¼š`cat /proc/sys/fs/inotify/max_user_watches`
- å¢åŠ é™åˆ¶ï¼š`echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches`

## é«˜çº§ç”¨æ³•

### 1. é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿ
```bash
# å°†è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶
sudo ./fanotify_demo /var/log 2>&1 | tee fanotify.log

# ä¸å…¶ä»–å·¥å…·ç»“åˆ
sudo ./fanotify_demo /etc | grep -E "(ssh|passwd|shadow)"
```

### 2. æ€§èƒ½è°ƒä¼˜
```bash
# ç›‘æ§ç‰¹å®šæ–‡ä»¶ç±»å‹ï¼ˆåœ¨ä»£ç ä¸­æ·»åŠ è¿‡æ»¤ï¼‰
# é¿å…ç›‘æ§ä¸´æ—¶æ–‡ä»¶å’Œç³»ç»Ÿæ–‡ä»¶
```

## å¼€å‘å‚è€ƒ

### APIæ–‡æ¡£
- `man 7 fanotify`ï¼šfanotifyæ¦‚è¿°
- `man 2 fanotify_init`ï¼šåˆå§‹åŒ–fanotify
- `man 2 fanotify_mark`ï¼šæ ‡è®°ç›‘æ§å¯¹è±¡

### ç›¸å…³é¡¹ç›®
- [inotify-tools](https://github.com/inotify-tools/inotify-tools)ï¼šåŸºäºinotifyçš„å·¥å…·é›†
- [sysdig](https://github.com/draios/sysdig)ï¼šç³»ç»Ÿç›‘æ§å·¥å…·
- [osquery](https://github.com/osquery/osquery)ï¼šç³»ç»ŸæŸ¥è¯¢æ¡†æ¶

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªä¸OpenWrtå·¥å…·å¥—ä»¶ç›¸åŒçš„è®¸å¯è¯ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªå·¥å…·ã€‚

---

**æ³¨æ„**ï¼šè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºå·¥å…·ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¯·å……åˆ†æµ‹è¯•ã€‚
