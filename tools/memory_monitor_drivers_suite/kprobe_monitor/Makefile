#!/usr/bin/make -f
# Kprobe å†…å­˜ç›‘æ§é©±åŠ¨ Makefile
# æ”¯æŒ ARM32, ARM64, x86, x64 æ¶æ„
# ä½œè€…: OpenWrt Tools Project

# é©±åŠ¨åç§°å’Œç‰ˆæœ¬
DRIVER_NAME := kprobe_monitor
DRIVER_VERSION := 1.2.0

# å†…æ ¸æ¨¡å—å¯¹è±¡
obj-m += $(DRIVER_NAME).o

# ç¼–è¯‘æ ‡å¿—
ccflags-y := -DDRIVER_VERSION=\"$(DRIVER_VERSION)\"
ccflags-y += -Wall -Wextra
ccflags-y += -DDEBUG

# æ¶æ„æ£€æµ‹å’Œä¼˜åŒ–
ifeq ($(ARCH),arm)
    ccflags-y += -DARCH_ARM32
    ccflags-y += -march=armv7-a
endif

ifeq ($(ARCH),arm64)
    ccflags-y += -DARCH_ARM64
    ccflags-y += -march=armv8-a
endif

ifeq ($(ARCH),x86)
    ccflags-y += -DARCH_X86_32
endif

ifeq ($(ARCH),x86_64)
    ccflags-y += -DARCH_X86_64
endif

# å†…æ ¸è·¯å¾„è‡ªåŠ¨æ£€æµ‹
KERNEL_VER ?= $(shell uname -r)
KERNEL_DIR ?= /lib/modules/$(KERNEL_VER)/build

# äº¤å‰ç¼–è¯‘æ”¯æŒ
ifdef CROSS_COMPILE
    KERNEL_DIR := $(KERNEL_BUILD_PATH)
    ARCH := $(ARCH)
endif

# OpenWrt ç¼–è¯‘æ”¯æŒ
ifdef STAGING_DIR
    KERNEL_DIR := $(LINUX_DIR)
endif

# é»˜è®¤ç›®æ ‡
all: modules

# ç¼–è¯‘æ¨¡å—
modules:
	@echo "========================================"
	@echo "ç¼–è¯‘ Kprobe å†…å­˜ç›‘æ§é©±åŠ¨"
	@echo "æ¶æ„: $(ARCH)"
	@echo "å†…æ ¸: $(KERNEL_VER)"
	@echo "å†…æ ¸ç›®å½•: $(KERNEL_DIR)"
	@echo "äº¤å‰ç¼–è¯‘: $(CROSS_COMPILE)"
	@echo "========================================"
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) modules
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(DRIVER_NAME).ko"

# æ¸…ç†
clean:
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) clean
	rm -f *.o *.ko *.mod.c *.mod *.order *.symvers
	rm -f .*.cmd .*.d
	rm -rf .tmp_versions/
	@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# å®‰è£…æ¨¡å—
install: modules
	@echo "å®‰è£… Kprobe ç›‘æ§é©±åŠ¨..."
	sudo insmod $(DRIVER_NAME).ko
	@echo "âœ… é©±åŠ¨å·²åŠ è½½"
	@echo "ğŸ“‹ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€:"
	@echo "   cat /proc/$(DRIVER_NAME)"
	@echo "   dmesg | tail"

# å¸è½½æ¨¡å—
uninstall:
	@echo "å¸è½½ Kprobe ç›‘æ§é©±åŠ¨..."
	-sudo rmmod $(DRIVER_NAME)
	@echo "ğŸ›‘ é©±åŠ¨å·²å¸è½½"

# é‡æ–°åŠ è½½
reload: uninstall install

# æŸ¥çœ‹çŠ¶æ€
status:
	@echo "=== é©±åŠ¨çŠ¶æ€ ==="
	@lsmod | grep $(DRIVER_NAME) || echo "é©±åŠ¨æœªåŠ è½½"
	@echo ""
	@echo "=== proc ä¿¡æ¯ ==="
	@if [ -f /proc/$(DRIVER_NAME) ]; then \
		cat /proc/$(DRIVER_NAME); \
	else \
		echo "/proc/$(DRIVER_NAME) ä¸å­˜åœ¨"; \
	fi

# æµ‹è¯•åŠŸèƒ½
test: status
	@echo ""
	@echo "=== åŠŸèƒ½æµ‹è¯• ==="
	@if [ -f /proc/$(DRIVER_NAME) ]; then \
		echo "1. æ·»åŠ  mmap ç›‘æ§..."; \
		echo "add test_mmap sys_mmap 0" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "2. æ·»åŠ  munmap ç›‘æ§..."; \
		echo "add test_munmap sys_munmap 0" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "3. åˆ—å‡ºå¯ç”¨ç¬¦å·..."; \
		echo "list_symbols" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "4. è§¦å‘ä¸€äº›å†…å­˜æ“ä½œä»¥æµ‹è¯•æ¢é’ˆ..."; \
		dd if=/dev/zero of=/tmp/test_mmap bs=1M count=1 2>/dev/null; \
		sleep 2; \
		rm -f /tmp/test_mmap; \
		echo "5. æŸ¥çœ‹å†…æ ¸æ—¥å¿—..."; \
		dmesg | tail -15 | grep $(DRIVER_NAME); \
		echo "6. æ¸…ç†æµ‹è¯•ç›‘æ§..."; \
		echo "del test_mmap" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "del test_munmap" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
	else \
		echo "é©±åŠ¨æœªåŠ è½½ï¼Œè¯·å…ˆè¿è¡Œ: make install"; \
	fi

# é«˜çº§æµ‹è¯• - ç›‘æ§ç‰¹å®šè¿›ç¨‹
test-process:
	@echo "=== è¿›ç¨‹ç‰¹å®šç›‘æ§æµ‹è¯• ==="
	@if [ -f /proc/$(DRIVER_NAME) ]; then \
		echo "æ·»åŠ é’ˆå¯¹ bash è¿›ç¨‹çš„ mmap ç›‘æ§..."; \
		echo "add bash_mmap sys_mmap 0 0 0 bash" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "åœ¨æ–°çš„ bash ä¸­æ‰§è¡Œä¸€äº›å‘½ä»¤æ¥è§¦å‘ç›‘æ§..."; \
		bash -c "echo 'test' > /tmp/kprobe_test; cat /tmp/kprobe_test; rm -f /tmp/kprobe_test"; \
		sleep 1; \
		echo "æŸ¥çœ‹ç›‘æ§ç»“æœ..."; \
		dmesg | tail -10 | grep $(DRIVER_NAME); \
		echo "æ¸…ç†ç›‘æ§..."; \
		echo "del bash_mmap" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
	else \
		echo "é©±åŠ¨æœªåŠ è½½ï¼Œè¯·å…ˆè¿è¡Œ: make install"; \
	fi

# æ¶æ„ç‰¹å®šæµ‹è¯•
test-arm32:
	$(MAKE) ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- test

test-arm64:
	$(MAKE) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- test

test-x86:
	$(MAKE) ARCH=x86 test

test-x86_64:
	$(MAKE) ARCH=x86_64 test

# OpenWrt ç¼–è¯‘
openwrt: modules
	@echo "âœ… OpenWrt ç¼–è¯‘å®Œæˆ"
	@echo "è¯·å°† $(DRIVER_NAME).ko å¤åˆ¶åˆ°ç›®æ ‡è®¾å¤‡"

# æ£€æŸ¥å†…æ ¸é…ç½®
check-config:
	@echo "=== æ£€æŸ¥å†…æ ¸é…ç½® ==="
	@echo "æ£€æŸ¥ Kprobe æ”¯æŒ..."
	@if [ -f /proc/config.gz ]; then \
		gunzip -c /proc/config.gz | grep -E "CONFIG_KPROBES|CONFIG_KRETPROBES|CONFIG_STACKTRACE" || echo "é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ç›¸å…³é€‰é¡¹"; \
	elif [ -f /boot/config-$(shell uname -r) ]; then \
		grep -E "CONFIG_KPROBES|CONFIG_KRETPROBES|CONFIG_STACKTRACE" /boot/config-$(shell uname -r) || echo "é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ç›¸å…³é€‰é¡¹"; \
	else \
		echo "æ— æ³•æ‰¾åˆ°å†…æ ¸é…ç½®æ–‡ä»¶"; \
	fi
	@echo ""
	@echo "æ£€æŸ¥ç¬¦å·è¡¨æ”¯æŒ..."
	@if [ -f /proc/kallsyms ]; then \
		echo "âœ… kallsyms å¯ç”¨"; \
		echo "å¯ç”¨çš„å†…å­˜ç›¸å…³ç¬¦å·æ•°é‡: $$(grep -E 'sys_mmap|sys_munmap|sys_brk|do_mmap|vmalloc' /proc/kallsyms | wc -l)"; \
	else \
		echo "âŒ kallsyms ä¸å¯ç”¨"; \
	fi

# ç¬¦å·æŸ¥æ‰¾
find-symbols:
	@echo "=== æŸ¥æ‰¾å†…å­˜ç›¸å…³ç¬¦å· ==="
	@if [ -f /proc/kallsyms ]; then \
		echo "mmap ç›¸å…³ç¬¦å·:"; \
		grep -i mmap /proc/kallsyms | head -10; \
		echo ""; \
		echo "å†…å­˜ç®¡ç†ç›¸å…³ç¬¦å·:"; \
		grep -E 'alloc|free' /proc/kallsyms | grep -v __free | head -10; \
	else \
		echo "kallsyms ä¸å¯ç”¨"; \
	fi

# åˆ›å»ºå®‰è£…åŒ…
package:
	@echo "åˆ›å»ºå®‰è£…åŒ…..."
	mkdir -p package/$(DRIVER_NAME)-$(DRIVER_VERSION)
	cp $(DRIVER_NAME).ko package/$(DRIVER_NAME)-$(DRIVER_VERSION)/
	cp README.md package/$(DRIVER_NAME)-$(DRIVER_VERSION)/
	cp test_driver.sh package/$(DRIVER_NAME)-$(DRIVER_VERSION)/
	cd package && tar czf $(DRIVER_NAME)-$(DRIVER_VERSION).tar.gz $(DRIVER_NAME)-$(DRIVER_VERSION)/
	@echo "âœ… å®‰è£…åŒ…å·²åˆ›å»º: package/$(DRIVER_NAME)-$(DRIVER_VERSION).tar.gz"

# è°ƒè¯•ä¿¡æ¯
debug:
	@echo "=== è°ƒè¯•ä¿¡æ¯ ==="
	@echo "PWD: $(PWD)"
	@echo "KERNEL_DIR: $(KERNEL_DIR)"
	@echo "ARCH: $(ARCH)"
	@echo "CROSS_COMPILE: $(CROSS_COMPILE)"
	@echo "ccflags-y: $(ccflags-y)"
	@file $(DRIVER_NAME).ko 2>/dev/null || echo "æ¨¡å—æœªç¼–è¯‘"
	@echo ""
	@echo "å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯:"
	@uname -a
	@echo ""
	@echo "å†…æ ¸æ¨¡å—ä¿¡æ¯:"
	@if [ -f $(DRIVER_NAME).ko ]; then \
		modinfo $(DRIVER_NAME).ko; \
	fi

# æ€§èƒ½æµ‹è¯•
benchmark:
	@echo "=== æ€§èƒ½åŸºå‡†æµ‹è¯• ==="
	@if [ -f /proc/$(DRIVER_NAME) ]; then \
		echo "æµ‹è¯•å‰è®°å½•æ—¶é—´..."; \
		time_start=$$(date +%s.%N); \
		echo "æ·»åŠ å¤šä¸ªç›‘æ§ç‚¹..."; \
		echo "add perf_mmap sys_mmap 0" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "add perf_munmap sys_munmap 0" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "add perf_brk sys_brk 0" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "æ‰§è¡Œå†…å­˜å¯†é›†å‹æ“ä½œ..."; \
		for i in $$(seq 1 10); do \
			dd if=/dev/zero of=/tmp/benchmark_$$$$i bs=1M count=1 2>/dev/null; \
			rm -f /tmp/benchmark_$$$$i; \
		done; \
		time_end=$$(date +%s.%N); \
		echo "æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: $$(echo "$$time_end - $$time_start" | bc -l 2>/dev/null || echo "N/A")ç§’"; \
		echo "æ¸…ç†ç›‘æ§ç‚¹..."; \
		echo "del perf_mmap" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "del perf_munmap" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "del perf_brk" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
	else \
		echo "é©±åŠ¨æœªåŠ è½½ï¼Œè¯·å…ˆè¿è¡Œ: make install"; \
	fi

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "Kprobe å†…å­˜ç›‘æ§é©±åŠ¨ Makefile"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all/modules       - ç¼–è¯‘é©±åŠ¨æ¨¡å—"
	@echo "  clean            - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  install          - ç¼–è¯‘å¹¶å®‰è£…é©±åŠ¨"
	@echo "  uninstall        - å¸è½½é©±åŠ¨"
	@echo "  reload           - é‡æ–°åŠ è½½é©±åŠ¨"
	@echo "  status           - æŸ¥çœ‹é©±åŠ¨çŠ¶æ€"
	@echo "  test             - è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•"
	@echo "  test-process     - æµ‹è¯•è¿›ç¨‹ç‰¹å®šç›‘æ§"
	@echo "  check-config     - æ£€æŸ¥å†…æ ¸é…ç½®"
	@echo "  find-symbols     - æŸ¥æ‰¾å†…å­˜ç›¸å…³ç¬¦å·"
	@echo "  benchmark        - æ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  package          - åˆ›å»ºå®‰è£…åŒ…"
	@echo "  openwrt          - OpenWrt ç¼–è¯‘"
	@echo "  debug            - æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯"
	@echo "  help             - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "æ¶æ„ç‰¹å®šæµ‹è¯•:"
	@echo "  test-arm32       - ARM32 æµ‹è¯•"
	@echo "  test-arm64       - ARM64 æµ‹è¯•" 
	@echo "  test-x86         - x86 æµ‹è¯•"
	@echo "  test-x86_64      - x86_64 æµ‹è¯•"
	@echo ""
	@echo "å˜é‡:"
	@echo "  ARCH             - ç›®æ ‡æ¶æ„ (arm, arm64, x86, x86_64)"
	@echo "  CROSS_COMPILE    - äº¤å‰ç¼–è¯‘å‰ç¼€"
	@echo "  KERNEL_DIR       - å†…æ ¸æºç è·¯å¾„"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make install                    # ç¼–è¯‘å¹¶å®‰è£…"
	@echo "  make test                       # åŸºæœ¬åŠŸèƒ½æµ‹è¯•"
	@echo "  make test-process              # è¿›ç¨‹ç›‘æ§æµ‹è¯•"
	@echo "  make check-config              # æ£€æŸ¥å†…æ ¸æ”¯æŒ"
	@echo "  make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- # äº¤å‰ç¼–è¯‘"

.PHONY: all modules clean install uninstall reload status test test-process package openwrt debug help
.PHONY: test-arm32 test-arm64 test-x86 test-x86_64 check-config find-symbols benchmark 