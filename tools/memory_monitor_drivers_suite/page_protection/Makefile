#!/usr/bin/make -f
# é¡µé¢ä¿æŠ¤å†…å­˜ç›‘æ§é©±åŠ¨ Makefile
# æ”¯æŒ ARM32, ARM64, x86, x64 æ¶æ„
# ä½œè€…: OpenWrt Tools Project

# é©±åŠ¨åç§°å’Œç‰ˆæœ¬
DRIVER_NAME := page_monitor
DRIVER_VERSION := 1.0.0

# å†…æ ¸æ¨¡å—å¯¹è±¡
obj-m += $(DRIVER_NAME).o

# ç¼–è¯‘æ ‡å¿—
ccflags-y := -DDRIVER_VERSION=\"$(DRIVER_VERSION)\"
ccflags-y += -Wall -Wextra
ccflags-y += -DDEBUG

# æ¶æ„æ£€æµ‹å’Œä¼˜åŒ–
ifeq ($(ARCH),arm)
    ccflags-y += -DARCH_ARM32
    ccflags-y += -march=armv7-a
endif

ifeq ($(ARCH),arm64)
    ccflags-y += -DARCH_ARM64
    ccflags-y += -march=armv8-a
endif

ifeq ($(ARCH),x86)
    ccflags-y += -DARCH_X86_32
endif

ifeq ($(ARCH),x86_64)
    ccflags-y += -DARCH_X86_64
endif

# å†…æ ¸è·¯å¾„è‡ªåŠ¨æ£€æµ‹
KERNEL_VER ?= $(shell uname -r)
KERNEL_DIR ?= /lib/modules/$(KERNEL_VER)/build

# äº¤å‰ç¼–è¯‘æ”¯æŒ
ifdef CROSS_COMPILE
    KERNEL_DIR := $(KERNEL_BUILD_PATH)
    ARCH := $(ARCH)
endif

# OpenWrt ç¼–è¯‘æ”¯æŒ
ifdef STAGING_DIR
    KERNEL_DIR := $(LINUX_DIR)
endif

# é»˜è®¤ç›®æ ‡
all: modules

# ç¼–è¯‘æ¨¡å—
modules:
	@echo "========================================"
	@echo "ç¼–è¯‘é¡µé¢ä¿æŠ¤å†…å­˜ç›‘æ§é©±åŠ¨"
	@echo "æ¶æ„: $(ARCH)"
	@echo "å†…æ ¸: $(KERNEL_VER)"
	@echo "å†…æ ¸ç›®å½•: $(KERNEL_DIR)"
	@echo "äº¤å‰ç¼–è¯‘: $(CROSS_COMPILE)"
	@echo "========================================"
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) modules
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(DRIVER_NAME).ko"

# æ¸…ç†
clean:
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) clean
	rm -f *.o *.ko *.mod.c *.mod *.order *.symvers
	rm -f .*.cmd .*.d
	rm -rf .tmp_versions/
	@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# å®‰è£…æ¨¡å—
install: modules
	@echo "å®‰è£…é¡µé¢ä¿æŠ¤ç›‘æ§é©±åŠ¨..."
	sudo insmod $(DRIVER_NAME).ko
	@echo "âœ… é©±åŠ¨å·²åŠ è½½"
	@echo "ğŸ“‹ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€:"
	@echo "   cat /proc/$(DRIVER_NAME)"
	@echo "   dmesg | tail"

# å¸è½½æ¨¡å—
uninstall:
	@echo "å¸è½½é¡µé¢ä¿æŠ¤ç›‘æ§é©±åŠ¨..."
	-sudo rmmod $(DRIVER_NAME)
	@echo "ğŸ›‘ é©±åŠ¨å·²å¸è½½"

# é‡æ–°åŠ è½½
reload: uninstall install

# æŸ¥çœ‹çŠ¶æ€
status:
	@echo "=== é©±åŠ¨çŠ¶æ€ ==="
	@lsmod | grep $(DRIVER_NAME) || echo "é©±åŠ¨æœªåŠ è½½"
	@echo ""
	@echo "=== proc ä¿¡æ¯ ==="
	@if [ -f /proc/$(DRIVER_NAME) ]; then \
		cat /proc/$(DRIVER_NAME); \
	else \
		echo "/proc/$(DRIVER_NAME) ä¸å­˜åœ¨"; \
	fi

# æµ‹è¯•åŠŸèƒ½
test: status
	@echo ""
	@echo "=== åŠŸèƒ½æµ‹è¯• ==="
	@if [ -f /proc/$(DRIVER_NAME) ]; then \
		echo "1. æµ‹è¯•è¯»å–..."; \
		echo "test_read 0" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "2. æµ‹è¯•å†™å…¥..."; \
		echo "test_write 100 Hello_Page_Monitor" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "3. å†æ¬¡è¯»å–..."; \
		echo "test_read 100" | sudo tee /proc/$(DRIVER_NAME) > /dev/null; \
		echo "4. æŸ¥çœ‹å†…æ ¸æ—¥å¿—..."; \
		dmesg | tail -10 | grep $(DRIVER_NAME); \
	else \
		echo "é©±åŠ¨æœªåŠ è½½ï¼Œè¯·å…ˆè¿è¡Œ: make install"; \
	fi

# æ¶æ„ç‰¹å®šæµ‹è¯•
test-arm32:
	$(MAKE) ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- test

test-arm64:
	$(MAKE) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- test

test-x86:
	$(MAKE) ARCH=x86 test

test-x86_64:
	$(MAKE) ARCH=x86_64 test

# OpenWrt ç¼–è¯‘
openwrt: modules
	@echo "âœ… OpenWrt ç¼–è¯‘å®Œæˆ"
	@echo "è¯·å°† $(DRIVER_NAME).ko å¤åˆ¶åˆ°ç›®æ ‡è®¾å¤‡"

# åˆ›å»ºå®‰è£…åŒ…
package:
	@echo "åˆ›å»ºå®‰è£…åŒ…..."
	mkdir -p package/$(DRIVER_NAME)-$(DRIVER_VERSION)
	cp $(DRIVER_NAME).ko package/$(DRIVER_NAME)-$(DRIVER_VERSION)/
	cp README.md package/$(DRIVER_NAME)-$(DRIVER_VERSION)/
	cp test_driver.sh package/$(DRIVER_NAME)-$(DRIVER_VERSION)/
	cd package && tar czf $(DRIVER_NAME)-$(DRIVER_VERSION).tar.gz $(DRIVER_NAME)-$(DRIVER_VERSION)/
	@echo "âœ… å®‰è£…åŒ…å·²åˆ›å»º: package/$(DRIVER_NAME)-$(DRIVER_VERSION).tar.gz"

# è°ƒè¯•ä¿¡æ¯
debug:
	@echo "=== è°ƒè¯•ä¿¡æ¯ ==="
	@echo "PWD: $(PWD)"
	@echo "KERNEL_DIR: $(KERNEL_DIR)"
	@echo "ARCH: $(ARCH)"
	@echo "CROSS_COMPILE: $(CROSS_COMPILE)"
	@echo "ccflags-y: $(ccflags-y)"
	@file $(DRIVER_NAME).ko 2>/dev/null || echo "æ¨¡å—æœªç¼–è¯‘"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "é¡µé¢ä¿æŠ¤å†…å­˜ç›‘æ§é©±åŠ¨ Makefile"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all/modules    - ç¼–è¯‘é©±åŠ¨æ¨¡å—"
	@echo "  clean         - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  install       - ç¼–è¯‘å¹¶å®‰è£…é©±åŠ¨"
	@echo "  uninstall     - å¸è½½é©±åŠ¨"
	@echo "  reload        - é‡æ–°åŠ è½½é©±åŠ¨"
	@echo "  status        - æŸ¥çœ‹é©±åŠ¨çŠ¶æ€"
	@echo "  test          - è¿è¡ŒåŠŸèƒ½æµ‹è¯•"
	@echo "  package       - åˆ›å»ºå®‰è£…åŒ…"
	@echo "  openwrt       - OpenWrt ç¼–è¯‘"
	@echo "  debug         - æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "æ¶æ„ç‰¹å®šæµ‹è¯•:"
	@echo "  test-arm32    - ARM32 æµ‹è¯•"
	@echo "  test-arm64    - ARM64 æµ‹è¯•" 
	@echo "  test-x86      - x86 æµ‹è¯•"
	@echo "  test-x86_64   - x86_64 æµ‹è¯•"
	@echo ""
	@echo "å˜é‡:"
	@echo "  ARCH          - ç›®æ ‡æ¶æ„ (arm, arm64, x86, x86_64)"
	@echo "  CROSS_COMPILE - äº¤å‰ç¼–è¯‘å‰ç¼€"
	@echo "  KERNEL_DIR    - å†…æ ¸æºç è·¯å¾„"

.PHONY: all modules clean install uninstall reload status test package openwrt debug help
.PHONY: test-arm32 test-arm64 test-x86 test-x86_64 