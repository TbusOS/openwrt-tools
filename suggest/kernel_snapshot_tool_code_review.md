# kernel_snapshot_tool 代码评审与改进建议

版本: v1.0  (面向 Linux 通用场景)

## 摘要
`kernel_snapshot_tool` 架构清晰、实现扎实：单线程遍历确保“不丢文件”，多线程并行处理文件内容，差异比较使用排序+双指针 (O(n+m))，可读性与可维护性均佳。若以“准确性优先”作为最高约束，通过少量关键改造即可成为一个通用且可靠的“文件系统快照与差异分析引擎”，支撑内核/CVE 补丁制作，并可延展到安全审计、配置回滚、CI 产物校验等更多场景。

## 关键结论
- 准确性必须绝对优先：哈希应基于“全量文件内容”。
- 并发模型需要“有界回压 + 流式写出”，避免超大目录下的内存压力。
- 增补权限等元数据与路径规范化，提高比对的工程可靠性。

## 必须修复（P0）
1. 全量哈希（准确性）
   - 将当前采样式 `fast_hash` 改为对文件“全量读取”的标准哈希。
   - 默认建议 `SHA-256`（更稳健），同时允许 `--hash=sha1|sha256|xxhash` 选择。
   - I/O 采用分块流式读取（如 1–4MB 缓冲），避免一次性 mmap 大文件。

2. use_git_hash 传递错误（功能 Bug）
   - 在工作线程中调用 `process_file_content(..., use_git_hash)` 时，当前误以 `pool->collector != NULL` 代替，导致行为与配置不符。
   - 建议在 `worker_pool_t` 增加 `int use_git_hash;`，构造时从 `config` 传入；工作线程按该标志调用正确的哈希函数。

3. 有界队列 + 流式写出（规模化与稳定性）
   - 工作队列由“无限链表”改为“有界循环队列”，生产者在满时等待，形成背压，避免 OOM。
   - 结果收集不再全部驻留内存：
     - 增加“写入线程”，从结果队列中批量取出并“顺序写入快照文件”。
     - 仅保留必要统计信息与少量窗口缓存，极大降低内存峰值。

4. 增补元数据与路径规范化（工程可靠性）
   - 在快照条目中增加：`st_mode`（权限/类型）、`uid/gid`（可选）。
   - 快照路径统一为相对 `Base Dir` 的相对路径；输出/解析时规范化分隔符与去除 `..`。
   - 对权限变更但内容不变的场景可准确识别。

5. `status` 子命令（与 diff 互补）
   - 载入历史快照为基线，实时扫描当前目录生成索引并对比，输出 A/M/D 变更清单；
   - 用于“制作补丁前”的变更审视与确认，配合 quilt 流程更顺畅。

## 建议增强（P1）
1. 忽略/包含规则
   - 支持 `.snapshotignore`，采用 `fnmatch()` 解析 glob 语法（`*`, `?`, `[]`, 目录/前缀、取反 `!`）。

2. I/O 与进度体验
   - 大缓冲顺序读、`posix_fadvise`(可选) 优化顺序访问；
   - `--verbose` 输出“每 N 万文件”进度与 ETA。

3. 输出格式
   - `--json` 输出，便于脚本/CI 消费；错误码与错误信息规范化。

4. 可插拔哈希接口
   - 抽象 `hash_provider`，支持 `sha1/sha256/xxhash`，兼顾准确性与性能取舍。

## 扩展能力（P2）
1. 内容对象库（`.snapshot/objects/`）
   - 保存历史版本的压缩文件内容（以内容哈希命名）；
   - 为 `diff --content` 与 `restore` 提供数据支撑。

2. `diff --content`
   - 检测到文件修改时，直接对“旧内容（对象库解压） vs 新内容（当前文件）”执行 `diff -u`，生成行级差异。

3. `restore`/`checkout`
   - 从指定快照恢复单文件或整目录到历史状态；支持“试运行/覆盖确认”。

4. 守护进程/实时监控（`monitor`）
   - 基于 `inotify` 监听创建/修改/删除/移动事件，输出事件流或自动产生增量快照；
   - 用于安全审计与入侵检测（AIDE/Tripwire 类场景）。

## 参考数据结构与流程要点
- `worker_pool_t` 新增：`use_git_hash`、`queue_capacity`、结果/工作两个有界队列、`writer_thread`。
- 快照写入线程：集中打开快照文件，按到达顺序写入条目，结束时写统计与尾部信息。
- 快照格式：保留 `# Version:` 与能力位，便于向后兼容与字段扩展。

## 里程碑建议
- M1（准确性基线）
  - 全量 `SHA-256`；use_git_hash 传递修正；`status`；记录 `st_mode`；相对路径；基本 JSON 输出。
- M2（稳定与易用）
  - 有界队列 + 流式写；`.snapshotignore`；大目录性能优化；进度/ETA。
- M3（高级能力）
  - 对象库；`diff --content`；`restore`；`monitor` 守护进程。

## 适配与场景
- 内核/CVE 补丁制作（与 quilt 配合）：在“准确性第一”的前提下提供高效变更识别；
- 服务器文件完整性监控：基线快照 + 周期 `status`/实时 `monitor`；
- 配置变更回滚：变更前快照、异常后 `diff/restore`；
- CI 产物校验：构建端与发布端快照比对，验证一致性。

---
如需，我可以按 M1 目标直接提交一版实现：全量 SHA-256、Bug 修复、有界队列雏形、流式写出与 `status` 基本功能。

