# `kernel_snapshot_tool` 功能拓展与应用场景建议文档

## 一、 核心定位

本工具的核心价值是一个 **高性能、高可靠的文件系统状态记录与分析引擎**。在确保了 **100% 准确性** (使用完整的 SHA1/SHA256 哈希) 的基础上，我们可以拓展其功能，使其应用场景远超目前的内核补丁制作。

---

## 二、 核心功能增强 (让现有功能更强大)

### 1. 实现 `status` 命令 (优先级: 最高)
- **功能**: 对比指定快照和 **当前文件系统** 的状态，实时显示哪些文件被“新增 (Untracked)”、“修改 (Modified)”或“删除 (Deleted)”。这基本等同于 `git status`。
- **实现思路**:
    1.  加载指定的快照文件到内存中的 `old_index`。
    2.  重新扫描一次当前目录，在内存中生成 `new_index`。
    3.  复用 `perform_diff_analysis` 核心逻辑，对比两个索引并输出结果。
- **价值**: 这是与 `diff` (对比两个历史快照) 功能互补的核心能力，能极大提升工具的日常可用性。

### 2. 增强 `diff` 命令，支持内容对比 (优先级: 高)
- **功能**: 增加 `--content` 选项，当 `diff` 检测到文件被修改时，可以直接调用 `diff -u` 命令来显示 **文件内容的具体差异**。
- **实现思路**:
    1.  **引入内容缓存库 (Object Store)**：在创建快照时，将每个文件的内容进行压缩（如 zlib），并以其内容的 SHA1 哈希作为文件名，存储到一个对象目录中 (例如 `.snapshot/objects/`)。
    2.  当执行 `diff --content` 时，从缓存库中找到旧文件版本的内容，解压后与当前文件系统中的新版本进行 `diff`。
- **价值**: 让工具从“元数据对比”升级到“内容对比”，成为一个真正的版本追踪工具。

---

## 三、 全新功能模块 (增加革命性能力)

### 1. 增加 `restore` (或 `checkout`) 命令
- **功能**: 基于上述的“内容缓存库”，实现将单个文件或整个目录恢复到任意一个历史快照的状态。
- **实现思路**:
    - `snapshot_tool restore <snapshot_file> <target_file_path>`
    - 在 `<snapshot_file>` 中查找 `<target_file_path>` 对应的 SHA1 哈希。
    - 从对象缓存库 (`.snapshot/objects/`) 中找到该哈希对应的文件内容，解压并覆盖当前文件。
- **价值**: 这是从“只读分析工具”到“可写管理工具”的质变，使其具备了基础的版本控制和灾备恢复能力。

### 2. 增加守护进程模式 (`monitor`)，用于实时监控
- **功能**: 以守护进程方式在后台运行，利用 Linux 的 `inotify` API 实时监控指定目录的文件变化（创建、修改、删除、移动）。一旦有变化，可立即记录日志或执行告警脚本。
- **实现思路**:
    1.  增加 `monitor` 命令。
    2.  调用 `inotify_init()` 创建一个 inotify 实例。
    3.  使用 `inotify_add_watch()` 对指定目录进行递归监控。
    4.  在事件循环中读取 `inotify` 文件描述符，处理文件系统变更事件。
- **价值**: 将工具的应用场景从“手动快照”扩展到 **“实时安全审计与入侵检测”**，性能远超周期性扫描。

### 3. 支持 `.gitignore` 风格的排除/包含规则
- **功能**: 当前的排除逻辑 (`strstr`) 不够灵活。应支持一个规则文件（如 `.snapshotignore`），可以使用通配符 (`*`), 目录匹配 (`/build/`), 取反 (`!`) 等高级规则。
- **实现思路**: 使用 `fnmatch()` 函数来替代 `strstr()`，它可以处理 `glob` 风格的模式匹配，能完美解析 `.gitignore` 风格的规则。
- **价值**: 这是成为一个通用工具的标配，极大提高了在复杂项目中的灵活性和易用性。

---

## 四、 应用场景拓展

具备以上功能后，`kernel_snapshot_tool` 将适用于以下场景：

1.  **服务器安全与完整性监控**:
    - **场景**: 监控 `/etc/`, `/bin/`, `/usr/bin/` 等核心系统目录，防止被篡改或植入后门。
    - **用法**: 创建基准快照，然后通过 `monitor` 实时监控或 `cron` 定期执行 `status`，生成完整性报告。这正是 **AIDE (Advanced Intrusion Detection Environment)** 或 **Tripwire** 这类商业工具的核心原理。

2.  **重要配置文件版本管理与快速回滚**:
    - **场景**: 管理 Web 服务器 (Nginx)、数据库 (PostgreSQL) 等复杂应用的配置文件集合。
    - **用法**: 每次变更前创建快照。如果更新导致服务异常，可立即 `diff` 定位改动，并用 `restore` 命令一键回滚。

3.  **轻量级的代码或文档版本控制**:
    - **场景**: 对于一些不适合使用 Git 的项目（如包含大量二进制文件、设计稿，或只是临时的脚本集合）。
    - **用法**: 作为一个比 Git 更简单、更快、侵入性更小的版本控制工具，只关注文件状态，没有分支、合并等复杂概念。

4.  **CI/CD 流程中的构建物验证**:
    - **场景**: 确保从构建服务器到生产服务器的部署过程中，软件包没有被篡改或损坏。
    - **用法**: 在 Build 阶段结束时创建快照。在 Deploy 阶段开始时，重新计算快照并 `diff`，确保两个快照完全一致，保证传输过程的完整性。

---

## 五、 架构和易用性改进

1.  **支持配置文件**: 允许通过 `/etc/snapshot.conf` 或 `~/.snapshotrc` 定义默认监控目录、排除规则等，提高易用性。
2.  **可插拔的哈希算法**: 将哈希计算抽象出来，允许用户通过命令行选择 (`--hash=sha1`, `--hash=sha256`, `--hash=xxhash`)，增加灵活性和未来扩展性。
3.  **JSON 输出**: 增加 `--json` 选项，让 `status` 和 `diff` 的结果以机器可读的格式输出，方便与其他脚本和工具链集成。
