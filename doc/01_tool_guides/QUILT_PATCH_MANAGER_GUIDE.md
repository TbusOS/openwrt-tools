# OpenWrt Quilt 补丁管理工具使用指南 v6.0

## 📋 概述 (v6.0 重构版)

本工具是专为 OpenWrt 内核补丁制作设计的自动化 bash 脚本。**v6.0 版本经过重大重构**，其核心设计思想已从一系列 quilt 命令的简单封装，演进为**以 Commit ID 为驱动的全自动化补丁制作工作流**。

新版工具旨在最大限度地减少手动操作，通过一个命令即可完成从“补丁兼容性测试”到“生成包含完整元数据的最终补丁”的全过程。

## 🚀 核心理念：从手工到自动

旧版本提供了大量 `quilt` 命令的直接封装（如 `push`, `pop`, `status`），虽然方便，但用户仍需手动、按顺序执行多个步骤来制作一个补丁，过程繁琐且容易出错。

**v6.0 的核心变革在于引入了 `auto-patch` 工作流**，将这些分散的步骤整合为一个原子操作。您只需提供一个 Commit ID 和补丁名，工具即可自动完成所有中间步骤。

## 📝 使用方法

### 🥇 首选命令：一键式自动化补丁制作 (`auto-patch`)

这是 **v6.0 最推荐**的使用方式。它整合了所有必要的步骤，是制作补丁最快、最安全的方式。

```bash
# 在 OpenWrt 根目录直接运行
./tools/quilt_patch_manager_final.sh auto-patch <commit_id> <patch_name>
```

**工作流程详解:**
1.  **兼容性测试**: 自动对指定的 `commit_id` 进行全面的兼容性分析。如果发现冲突，会给出警告并让用户确认是否继续。
2.  **创建补丁**: 在内核源码目录中自动创建一个新的 quilt 补丁。
3.  **添加文件**: 自动提取该 commit 涉及的所有文件，并使用 `quilt add` 将它们添加到补丁中。
4.  **等待用户修改**: 脚本会在此暂停，等待您根据需要**手动修改代码**以解决冲突或进行适配。
5.  **生成最终补丁**: 您修改完成后，按回车键，脚本会自动执行 `refresh-with-header`，生成包含原始作者、日期和提交信息的最终补丁文件，并将其拷贝到 `output` 目录。

---

### 🛠️ 手动分步命令 (高级用户)

如果您想更精细地控制每一步，仍然可以使用以下分步命令。

#### 步骤 1: 补丁兼容性测试 (`test-patch`)

在正式操作前，务必使用此命令检查补丁与当前内核的兼容性。

```bash
./tools/quilt_patch_manager_final.sh test-patch <commit_id>
```

#### 步骤 2: 创建空补丁 (`create-patch`)

此命令会在内核源码的 `patches` 目录下创建一个新的、空的补丁。

```bash
./tools/quilt_patch_manager_final.sh create-patch <patch_name>
```

#### 步骤 3: 提取并添加文件 (`extract-files` & `add-files`)

首先提取 commit 涉及的文件列表，然后将它们添加到上一步创建的补丁中。

```bash
# 1. 提取文件列表到 output/patch_files.txt
./tools/quilt_patch_manager_final.sh extract-files <commit_id>

# 2. 将文件列表中的文件添加到当前 quilt 补丁
./tools/quilt_patch_manager_final.sh add-files patch_files.txt
```

#### 步骤 4: 手动修改代码

这是手动操作步骤。您需要根据原始补丁的内容，在内核源码中进行相应修改。

#### 步骤 5: 生成带元数据的最终补丁 (`refresh-with-header`)

这是**替代旧 `refresh` 和 `auto-refresh` 的核心命令**。它会在生成补丁的同时，从原始 commit 中提取元数据（作者、日期、主题等）并注入到最终生成的补丁文件头部。

```bash
./tools/quilt_patch_manager_final.sh refresh-with-header <commit_id>
```
最终补丁会自动拷贝到 `output` 目录。

---

### 🧰 辅助与工具命令

#### 📥 补丁获取 (`fetch` & `save`)

- `fetch <commit_id>`: 下载补丁到临时目录，供脚本内部使用，会自动清理。
- `save <commit_id> [filename]`: 下载补丁并**永久保存**到当前目录，方便离线查看。

#### 📄 信息提取 (`extract-files` & `extract-metadata`)

- `extract-files <commit_id>`: 提取补丁涉及的文件列表，保存到 `output/patch_files.txt`。
- `extract-metadata <commit_id>`: 提取补丁的元数据（头部信息），保存到 `output/patch_metadata.txt`。

#### 🧹 环境管理 (`clean` & `reset-env`)

- `clean`: 以交互方式清理 `output` 和 `cache` 目录。
- `reset-env`: **危险操作**。强制重置 quilt 环境，包括撤销所有已应用补丁和删除 `patches` 目录下的所有补丁文件。

#### 🔎 Quilt 通用命令

为了简化操作，所有标准的 `quilt` 命令（如 `status`, `series`, `diff` 等）现在可以通过脚本直接调用。脚本会自动切换到内核源码目录执行它们。

```bash
# 查看 quilt 状态
./tools/quilt_patch_manager_final.sh status

# 查看补丁系列
./tools/quilt_patch_manager_final.sh series

# 查看当前修改
./tools/quilt_patch_manager_final.sh diff
```

---

## 🚫 v6.0 中废弃的命令

为了使工具的工作流更加清晰和专注，以下在旧版本中存在的命令已被**移除或整合**：

| 废弃命令 | 替代方案 |
| :--- | :--- |
| `quilt_push` / `quilt_pop` | 已废弃。补丁的应用/移除应由 `quilt` 原生命令或新的 `auto-patch` 流程管理。 |
| `quilt_status`, `quilt_series`, 等 | 已废弃独立的封装函数，现在通过通用命令执行器运行 (e.g., `./script.sh status`)。|
| `refresh` | 已被 `refresh-with-header` 替代，以确保元数据总是被注入。如果需要纯净的 `refresh`，请使用 `./script.sh refresh`。|
| `auto-refresh` | 功能已完全被 `refresh-with-header` 覆盖并整合进 `auto-patch` 流程。|
| `integrate-metadata` | 已废弃。元数据注入是 `refresh-with-header` 的核心功能，不再需要独立命令。|
| `delete-patch` | 已废弃。请使用 `quilt delete` 命令进行操作。|

## 🚀 完整工作流程示例 (v6.0)

**场景**: 为 OpenWrt 内核合入一个来自上游的修复 `commit: 654b33ada4ab`。

#### 步骤 1: （可选）兼容性测试

```bash
cd /path/to/openwrt
./tools/quilt_patch_manager_final.sh test-patch 654b33ada4ab
```
> 分析输出，确保补丁可以被应用。

#### 步骤 2: 一键执行自动化流程

```bash
./tools/quilt_patch_manager_final.sh auto-patch 654b33ada4ab 952-kernel-proc-fix-uaf.patch
```

#### 步骤 3: 等待手动修改提示

脚本会自动完成补丁创建和文件添加，然后暂停并提示：
> "补丁已创建，文件已添加。现在是手动修改代码以解决冲突的最佳时机。
> 修改完成后，按 Enter 键继续以生成最终补丁..."

此时，您可以打开一个新的终端，进入 `build_dir/.../linux-6.6.x` 目录，根据需要修改代码。

如果您在上游找到的补丁是完全兼容的，那么**通常不需要任何手动修改**。

#### 步骤 4: 完成修改并生成最终补丁

在您完成手动修改（或无需修改）后，回到运行脚本的终端，按 `Enter` 键。脚本将自动完成后续工作。

**最终输出**:
```
✅ 补丁已成功生成: patches/952-kernel-proc-fix-uaf.patch
📄 最终补丁已拷贝到: /path/to/openwrt/output/952-kernel-proc-fix-uaf.patch
```
现在，`output` 目录下的补丁文件就是包含完整元数据的、可以直接使用的最终产物。

---
**版本**: 6.0  
**更新时间**: 2024-08-05

---

## 📜 历史版本更新日志

### v5.7 (2025-01-12) 🚀 重大功能更新
- 🆕 **智能元数据集成**: 新增 `auto-refresh` 命令，生成补丁并自动集成CVE元数据
- 🔧 **命令功能分离**: 拆分 `refresh` 命令，分离纯补丁生成和元数据集成功能
- ✨ **手动元数据集成**: 新增 `integrate-metadata` 命令，手动集成元数据到指定补丁
- 🌐 **网络连接优化**: 新增 `download-patch` 和 `test-network` 命令，解决网络超时问题
- 📚 **工作流程增强**: 更新手动制作补丁流程，新增元数据提取步骤
- 🎯 **单一职责原则**: 增强命令分离，提升工具灵活性

### v5.6 (2025-01-12) 🔧 稳定性提升
- 💾 **补丁缓存机制**: 避免重复下载同一补丁，大大提升速度
- 🔧 **冲突分析优化**: 智能多文件冲突分配，完美冲突分析
- 🛠️ **网络超时解决**: 专门的网络问题诊断和解决方案

### v5.5 (2025-01-12) 🎯 用户体验优化
- ⚡ **性能优化**: 多重备用机制，提升脚本稳定性
- 🛠️ **错误处理**: 改进错误处理逻辑，提供更友好的反馈

### v5.4 (2025-01-12) 💪 显示增强
- 💪 **强化显示**: 强制显示基本信息，确保不空白
- 🔧 **中断修复**: 修复脚本在冲突分析时意外中断的问题

### v5.3 (2025-08-04) 🔧 功能增强更新
- 🔧 **增强的文件冲突检测**: 升级的冲突检测算法，更精确地识别潜在冲突
- 🧠 **智能补丁兼容性分析**: 改进的兼容性分析引擎，提供更准确的评估
- 📋 **精确的补丁术语显示**: 优化的输出格式，更清晰的状态展示
- 🏗️ **完整的版本管理系统**: 全面的版本控制和状态管理机制
- 🧪 **6步骤检测流程**: 下载补丁 → 检查内核目录 → 分析文件 → 检查存在性 → 冲突检测 → 干运行测试

### v5.2 (2025-08-04) - 稳定性改进
- 🐛 **修复关键问题**: 解决了多个稳定性问题
- ⚡ **性能优化**: 提升了检测和处理速度

### v5.1 (2025-08-04) 🔍 智能检测新增
- 🧪 **补丁兼容性检测**: 新增 `test-patch` 命令，智能检测补丁与当前内核的兼容性
- 🔍 **自动冲突分析**: 自动检测文件存在性、补丁是否已应用、是否存在冲突
- 🛑 **安全防护机制**: 检测到不兼容时自动阻止危险操作，保护内核代码
- 🚦 **智能流程控制**: `auto-patch` 自动集成兼容性检测，提供安全建议
- 📊 **详细检测报告**: 提供文件统计、冲突详情和解决建议

### v5.0 (2025-08-04) 🧹 功能完善
- 🧹 **补丁清理功能**: 智能清理补丁和临时文件，支持交互式确认
- 📊 **Quilt 常用命令集成**: 内置 status、series、applied、unapplied、top、files、push、pop 等命令
- 🎨 **友好界面显示**: 为所有 quilt 命令提供格式化输出和状态标识
- 🔧 **补丁状态管理**: 一键查看补丁应用状态和详细信息

### v4.0 (2025-08-04) 🚀 重大更新
- 🚀 **自动内核目录查找**: 脚本自动查找并切换到 OpenWrt 内核源码目录
- 🎯 **简化工作流程**: 所有命令可直接在 OpenWrt 根目录执行
- 🔍 **智能路径检测**: 支持多种 OpenWrt 目录结构的自动识别
- 📂 **告别手动切换**: 无需执行 `cd build_dir/target-*/linux-*/linux-*/`
- 🔧 **修复输出混乱**: 解决 fetch_patch 函数的日志和返回值混合问题
- 🌈 **颜色显示优化**: 进一步改进终端兼容性

### v3.0 (2025-08-04)
- ✅ **新增 save 命令**: 支持保存原始补丁到当前目录
- ✅ 支持自定义文件名或使用默认 commit ID 作为文件名
- ✅ 自动添加 .patch 扩展名
- ✅ 在 auto-patch 流程中自动保存原始补丁供参考
- ✅ 完善帮助信息，明确区分临时文件和持久文件
- ✅ 更新演示功能，展示 save 命令的使用

### v2.0 (2025-08-04)
- ✅ 完善帮助信息，详细说明临时目录机制
- ✅ 增加彩色输出和更好的用户界面
- ✅ 明确区分临时文件和持久文件

### v1.0 (2025-08-04)
- ✅ 初始版本，支持基本的补丁管理功能
